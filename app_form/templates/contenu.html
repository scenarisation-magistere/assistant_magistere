<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contenus par Section - Formation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation.css') }}">
    <style>
        /* Page-specific styles for contenu.html */

        .step-indicator .step.active {
            color: var(--primary-blue);
        }

        .competences-recall {
            background: var(--bg-info-light);
            padding: var(--spacing-lg);
            border-radius: var(--radius-small);
            margin-bottom: var(--spacing-xl);
            border-left: 4px solid var(--primary-blue);
        }

        .competences-recall h3 {
            color: var(--primary-blue);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-xl);
        }

        .competences-recall .data-item {
            margin: var(--spacing-sm) 0;
            padding: var(--spacing-sm);
            background: rgba(255,255,255,0.5);
            border-radius: 5px;
        }

        .competences-recall .data-item strong {
            color: var(--primary-blue);
        }

        .competences-recall .competence-item {
            margin: var(--spacing-sm) 0;
            padding: var(--spacing-sm);
            background: rgba(255,255,255,0.7);
            border-radius: var(--radius-small);
            border-left: 3px solid var(--primary-blue);
            font-size: var(--font-size-small);
            line-height: 1.4;
        }

        /* New: richer competence display */
        .competences-recall .competence-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .competences-recall .competence-code {
            background: var(--primary-blue);
            color: #fff;
            border-radius: 12px;
            padding: 2px 8px;
            font-weight: 600;
            letter-spacing: 0.2px;
        }
        .competences-recall .competence-title {
            color: var(--text-dark);
            font-weight: 600;
            font-size: var(--font-size-large);
        }
        .competences-recall .competence-desc {
            color: var(--text-medium);
        }

        .competences-recall .competence-item strong {
            color: var(--primary-blue);
            font-weight: 600;
        }

        .ai-generate-section {
            text-align: center;
            margin: var(--spacing-xl) 0;
            padding: var(--spacing-xl);
            background: linear-gradient(135deg, var(--light-gray) 0%, var(--medium-gray) 100%);
            border-radius: var(--radius-medium);
            border: 2px dashed var(--primary-blue);
        }

        .ai-generate-btn {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            border: none;
            padding: 12px 26px;
            font-size: var(--font-size-large);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }

        .ai-generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.4);
        }

        .ai-generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-loading {
            text-align: center;
            margin: 30px 0;
        }

        .ai-loading p {
            color: var(--text-medium);
            margin-top: 15px;
        }

        .section-results {
            background: white;
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-medium);
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .section-results h4 {
            color: var(--primary-blue);
            margin-bottom: var(--spacing-md);
        }

        .section-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--spacing-md) 0;
        }

        .section-table th,
        .section-table td {
            border: 1px solid var(--border-gray);
            padding: var(--spacing-sm);
            text-align: left;
        }

        .section-table th {
            background: var(--light-gray);
            font-weight: 600;
            color: var(--text-dark);
        }

        .section-table td {
            background: white;
            color: var(--text-medium);
        }

        .section-table .section-number {
            font-weight: 600;
            color: var(--primary-blue);
        }

        .section-table .section-type {
            font-weight: 600;
            color: var(--text-dark);
        }

        .section-table .competence-visee {
            font-style: italic;
            color: var(--text-medium);
        }

        .section-table .ressource {
            color: var(--primary-green);
            font-weight: 600;
        }

        .section-table .activite {
            color: var(--secondary-orange);
            font-weight: 600;
        }

        .section-table .intention {
            color: var(--primary-blue);
            font-size: var(--font-size-small);
        }

        .section-table .justification {
            font-size: var(--font-size-small);
            color: var(--text-medium);
            font-style: italic;
            max-width: 200px;
            word-wrap: break-word;
        }

        /* AI Results specific styles */
        #aiResultsSection {
            margin: var(--spacing-xl) 0;
        }

        #aiResultsSection .section-results {
            background: var(--bg-info-light);
            border: 2px solid var(--border-info);
        }

        #aiResultsSection .section-results h4 {
            color: var(--text-info);
            font-size: var(--font-size-xl);
        }

        #aiResultsSection .section-results p {
            color: var(--text-medium);
            margin-bottom: var(--spacing-lg);
        }

        /* View options styles */
        .view-options {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            justify-content: center;
        }

        .view-option-btn {
            background: var(--light-gray);
            border: 2px solid var(--border-gray);
            color: var(--text-medium);
            padding: 8px 16px;
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: var(--font-size-normal);
        }

        .view-option-btn.active {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white;
        }

        .view-option-btn:hover {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white;
        }

        /* Simplified table styles */
        .simplified-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--spacing-md) 0;
        }

        .simplified-table th,
        .simplified-table td {
            border: 1px solid var(--border-gray);
            padding: var(--spacing-sm);
            text-align: left;
        }

        .simplified-table th {
            background: var(--light-gray);
            font-weight: 600;
            color: var(--text-dark);
        }

        .simplified-table td {
            background: white;
            color: var(--text-medium);
        }

        .simplified-table .section-number {
            font-weight: 600;
            color: var(--primary-blue);
            width: 80px;
        }

        .simplified-table .section-type {
            font-weight: 600;
            color: var(--text-dark);
            width: 150px;
        }

        .simplified-table .competence-visee {
            font-style: italic;
            color: var(--text-medium);
            max-width: 300px;
        }

        .simplified-table .ressource {
            color: var(--primary-green);
            font-weight: 600;
            max-width: 200px;
        }

        .simplified-table .activite {
            color: var(--secondary-orange);
            font-weight: 600;
            max-width: 200px;
        }

        /* Detailed view styles */
        .detailed-view {
            display: none;
        }

        .section-card {
            background: white;
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-medium);
            margin: var(--spacing-lg) 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-card-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-card-header h5 {
            margin: 0;
            font-size: var(--font-size-lg);
        }

        .section-card-header .section-number {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .section-card-content {
            padding: var(--spacing-lg);
        }

        .section-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .section-info-item {
            background: var(--bg-info-light);
            padding: var(--spacing-md);
            border-radius: var(--radius-small);
            border-left: 4px solid var(--primary-blue);
        }

        .section-info-item h6 {
            color: var(--primary-blue);
            margin: 0 0 var(--spacing-sm) 0;
            font-size: var(--font-size-md);
        }

        .section-info-item p {
            margin: 0;
            color: var(--text-medium);
            line-height: 1.5;
        }

        .section-info-item .competence-highlight {
            background: var(--primary-blue);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: var(--font-size-small);
            font-weight: 600;
            display: inline-block;
            margin-bottom: var(--spacing-sm);
        }

        .section-actions {
            background: var(--light-gray);
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-gray);
        }

        .section-actions h6 {
            color: var(--text-dark);
            margin: 0 0 var(--spacing-sm) 0;
        }

        .action-item {
            display: flex;
            align-items: center;
            margin: var(--spacing-sm) 0;
            padding: var(--spacing-sm);
            background: white;
            border-radius: var(--radius-small);
            border-left: 3px solid var(--primary-green);
        }

        .action-item .action-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-md);
            font-weight: 600;
        }

        .action-item .action-content {
            flex: 1;
        }

        .action-item .action-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .action-item .action-intention {
            font-size: var(--font-size-small);
            color: var(--text-medium);
            font-style: italic;
        }

        .justification-box {
            background: var(--bg-success-light);
            border: 1px solid var(--border-success);
            border-radius: var(--radius-small);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .justification-box h6 {
            color: var(--text-success);
            margin: 0 0 var(--spacing-sm) 0;
        }

        .justification-box p {
            margin: 0;
            color: var(--text-medium);
            line-height: 1.5;
        }

        /* Navigation between detailed views */
        /* Topbar for detailed view */
        .detailed-topbar {
            position: sticky;
            top: 0;
            z-index: 5;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
            backdrop-filter: saturate(1.1) blur(2px);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-small);
            padding: var(--spacing-sm) var(--spacing-md);
            margin: var(--spacing-md) 0 var(--spacing-lg) 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
        }

        .detailed-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-detail-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-small);
        }

        .nav-detail-btn:hover {
            background: var(--secondary-blue);
        }

        .nav-detail-btn:disabled {
            background: var(--border-gray);
            cursor: not-allowed;
        }

        .section-counter {
            font-weight: 600;
            color: var(--text-dark);
        }

        .navigation-tips {
            text-align: center;
            margin-top: var(--spacing-sm);
            font-size: 0.9em;
            color: var(--text-medium);
        }

        /* Responsive design for new components */
        @media (max-width: 768px) {
            .view-options {
                flex-direction: column;
                gap: var(--spacing-sm);
            }

            .section-info-grid {
                grid-template-columns: 1fr;
            }

            .section-card-header {
                flex-direction: column;
                gap: var(--spacing-sm);
                text-align: center;
            }

            .detailed-navigation {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
        }

        /* Table responsive design */
        @media (max-width: 1200px) {
            .section-table {
                font-size: var(--font-size-small);
            }
            
            .section-table th,
            .section-table td {
                padding: var(--spacing-xs);
            }
        }

        @media (max-width: 768px) {
            .section-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }



        .submit-section {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, var(--light-gray) 0%, var(--medium-gray) 100%);
            border-radius: 15px;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(32, 191, 107, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(32, 191, 107, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: var(--bg-danger-light);
            border: 1px solid var(--border-danger);
            border-radius: var(--radius-small);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            color: var(--text-danger);
            text-align: center;
        }

        .success-message {
            background: var(--bg-success-light);
            border: 1px solid var(--border-success);
            border-radius: var(--radius-small);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            color: var(--text-success);
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content-container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .contenus-grid {
                grid-template-columns: 1fr;
            }


        }
    </style>
</head>
<body>
    <div class="container">     
        {% include 'includes/header.html' %}   
        <div class="content-container">
            
            {% set instructions_header = 'G√©n√©ration des contenus p√©dagogiques' %}
            {% set instructions_subtitle = "L‚ÄôIA g√©n√®re automatiquement les contenus du parcours selon le sc√©nario hybride CMO." %}
            {% set instructions = [
                'Intentions p√©dagogiques ABC ‚Äî Prioritaires : Acquisition, Collaboration, Discussion, Pratique ; Compl√©mentaires : Production, Enqu√™te.',
                'Niveau de difficult√© de chaque comp√©tence vis√©e.',
                'S√©lection pr√©‚Äëorient√©e de ressources et activit√©s Magist√®re (valid√©e par la Communaut√© Magist√®re Occitanie). Voir le <a href="https://nuage02.apps.education.fr/index.php/s/8TZDK9gYr7nZ4EH?dir=/&openfile=true">tableur</a>'
            ] %}
            {% from 'includes/blocks/components.html' import instructions_panel %}
            {{ instructions_panel(instructions_header, instructions_subtitle, instructions, '') }}


            <!-- Comp√©tences Recall Section -->
            <div class="competences-recall">
                <h3>üìã Comp√©tences S√©lectionn√©es</h3>
                <div id="competences-list">
                        {% if competences_for_display %}
                            {% for comp in competences_for_display %}
                                <div class="competence-item">
                                    <div class="competence-header">
                                        <span class="competence-code">{{ comp.code }}</span>
                                        <span class="competence-title">{{ comp.titre if comp.titre else comp.formulation }}</span>
                                    </div>
                                    {% if comp.titre and comp.formulation %}
                                        <div class="competence-desc">{{ comp.formulation }}</div>
                                    {% elif comp.idees_cles %}
                                        <div class="competence-desc">{{ comp.idees_cles }}</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="competence-item" style="color: #666; font-style: italic;">
                                Aucune comp√©tence d√©finie
                            </div>

                        {% endif %}
                </div>
            </div>

            <!-- AI Generation Section -->
            <div class="ai-generate-section">
                <h3>G√©n√©ration des contenus p√©dagogiques</h3>
                <button class="ai-generate-btn" id="generateContenusBtn" onclick="generateContenus()">
                    ‚ú® G√©n√©rer les Contenus
                </button>
                
                {% from 'includes/blocks/components.html' import loading %}
                {{ loading('aiLoading', 'G√©n√©ration des contenus en cours...') }}
            </div>

            <!-- Error/Success Messages -->
            {% from 'includes/blocks/components.html' import messages %}
            {{ messages() }}

            <!-- AI Generated Results Section -->
            <div id="aiResultsSection" style="display: none;">
                <div class="section-results">
                    <h4>üìã Contenus G√©n√©r√©s par l'IA</h4>
                    <p>Voici les contenus g√©n√©r√©s automatiquement par l'IA. Choisissez votre mode d'affichage :</p>
                    
                    <!-- View Options -->
                    <div class="view-options">
                        <button class="view-option-btn active" onclick="switchView('simplified')">
                            üìä Tableau Simplifi√©
                        </button>
                        <button class="view-option-btn" onclick="switchView('detailed')">
                            üîç Vue D√©taill√©e
                        </button>
                    </div>
                    
                    <!-- Simplified Table View -->
                    <div id="simplifiedView" class="simplified-view">
                        <div id="simplifiedTableContent">
                            <!-- Simplified table will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Detailed View -->
                    <div id="detailedView" class="detailed-view">
                        <!-- Topbar: navigation + tips -->
                        <div class="detailed-topbar">
                            <div class="detailed-navigation">
                                <button class="nav-detail-btn" id="prevSectionBtn" onclick="showPreviousSection()">‚Üê Pr√©c√©dent</button>
                                <div class="section-counter">Section <span id="currentSectionNumber">1</span> sur <span id="totalSections">0</span></div>
                                <button class="nav-detail-btn" id="nextSectionBtn" onclick="showNextSection()">Suivant ‚Üí</button>
                            </div>
                            <div class="navigation-tips">
                                üí° Utilisez les fl√®ches ‚Üê ‚Üí ou la barre d'espace pour naviguer ‚Äî seules les sections avec des comp√©tences sont affich√©es
                            </div>
                        </div>
                        
                        <div id="detailedContent">
                            <!-- Detailed section cards will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Section -->
            {% from 'includes/blocks/components.html' import submit_section %}
            {% set next_label = '‚úÖ Valider et Continuer vers ' ~ (get_page_name_by_step(nav_info.step + 1)) %}
            {{ submit_section('submitBtn', next_label, 'saveContenus()') }}
        </div>
    </div>

    {% include 'includes/success_modal.html' %}
    {% include 'includes/footer.html' %}

    <script src="{{ url_for('static', filename='js/common_validation.js') }}"></script>
    <script>
        // Global variables
        let competences = [];
        let contenusData = {};
        let resourcesCatalog = [];

        // Normalize any value to a safe string for rendering
        function normalizeValue(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'object') {
                try {
                    return JSON.stringify(value);
                } catch (e) {
                    return String(value);
                }
            }
            return String(value);
        }

        // New: Known labels and preferred order for dynamic columns
        const FIELD_LABELS = {
            section: 'Section',
            type_de_section: 'Type',
            type: 'Type',
            code_competence: 'Code comp√©tence',
            competences_visees: 'Comp√©tences vis√©es',
            competence_visee: 'Comp√©tence vis√©e',
            ressource: 'Ressource',
            intention_ressource: 'Intention ressource',
            justification_ressource: 'Justification ressource',
            activite_1: 'Activit√© 1',
            intention_activite_1: 'Intention activit√© 1',
            justification_activite_1: 'Justification activit√© 1',
            activite_2: 'Activit√© 2',
            intention_activite_2: 'Intention activit√© 2',
            justification_activite_2: 'Justification activit√© 2',
            justification_activite_s: 'Justification activit√©(s)'
        };

        const PREFERRED_ORDER = [
            'section',
            'type_de_section',
            'type',
            'code_competence',
            'competences_visees',
            'competence_visee',
            'ressource',
            'intention_ressource',
            'justification_ressource',
            'activite_1',
            'intention_activite_1',
            'justification_activite_1',
            'activite_2',
            'intention_activite_2',
            'justification_activite_2',
            'justification_activite_s'
        ];

        // Exclusions for simplified table view (avoid overly verbose columns)
        const EXCLUDE_IN_SIMPLIFIED_PREFIXES = ['justification_'];

        function collectDynamicColumns(data) {
            const allKeys = new Set();
            (data || []).forEach(item => {
                if (item && typeof item === 'object') {
                    Object.keys(item).forEach(k => allKeys.add(k));
                }
            });
            // Remove keys that are always empty across rows
            const keys = Array.from(allKeys);
            const nonEmptyKeys = keys.filter(key => {
                return (data || []).some(item => {
                    const v = item ? item[key] : undefined;
                    const s = normalizeValue(v);
                    return s && s.trim() !== '' && s !== '-';
                });
            });
            // Exclude noisy fields from simplified table
            const filteredKeys = nonEmptyKeys.filter(key => !EXCLUDE_IN_SIMPLIFIED_PREFIXES.some(p => key.startsWith(p)));
            // Order: preferred first (as present), then rest alphabetically
            const preferred = PREFERRED_ORDER.filter(k => filteredKeys.includes(k));
            const rest = filteredKeys.filter(k => !preferred.includes(k)).sort();
            return [...preferred, ...rest];
        }

        function labelForKey(key) {
            return FIELD_LABELS[key] || key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        // Extract a human-friendly title from a value that may be an object or an inline map string
        function displayTitle(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'object') {
                try {
                    const keys = Object.keys(value);
                    const nameKey = keys.find(k => /^(nom|name|titre|label|intitule|intitul√©|Nom de l'activit√© ou ressource)$/i.test(k));
                    if (nameKey) return normalizeValue(value[nameKey]);
                } catch (_) {}
                return normalizeValue(value);
            }
            const s = String(value);
            // Try to extract from inline map-like strings
            let m = s.match(/Nom de l['‚Äô]activit√© ou ressource\s*:\s*([^,}\n]+)/i);
            if (m) return m[1].trim();
            m = s.match(/Nom\s*:\s*([^,}\n]+)/i);
            if (m) return m[1].trim();
            m = s.match(/Titre\s*:\s*([^,}\n]+)/i);
            if (m) return m[1].trim();
            return s;
        }

        // Helpers for competence title/formulation extraction
        function stripLeadingCode(text) {
            if (!text) return '';
            const s = String(text);
            const m = s.match(/^([A-Z]\d+)\s*[-‚Äì:]?\s*(.*)$/);
            return m ? m[2] : s;
        }

        function getCompetenceTitleAndFormulation(competenceText, competenceDetails) {
            const titleFromDetails = competenceDetails && competenceDetails.titre ? String(competenceDetails.titre) : '';
            const formulationFromDetails = competenceDetails && competenceDetails.formulation ? String(competenceDetails.formulation) : '';
            if (titleFromDetails || formulationFromDetails) {
                return {
                    title: titleFromDetails || stripLeadingCode(competenceText || ''),
                    formulation: formulationFromDetails || stripLeadingCode(competenceText || '')
                };
            }
            const stripped = stripLeadingCode(competenceText || '');
            return { title: stripped, formulation: stripped };
        }

        // Load competences data
        document.addEventListener('DOMContentLoaded', function() {
            // Load competences from the backend
            loadCompetencesData();
            // Load resources catalog for enrichment
            loadResourcesCatalog();
            
            // Add keyboard shortcuts for detailed view navigation
            document.addEventListener('keydown', function(e) {
                const detailedView = document.getElementById('detailedView');
                if (detailedView.style.display !== 'none') {
                    if (e.key === 'ArrowRight' || e.key === ' ') {
                        e.preventDefault();
                        showNextSection();
                    } else if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        showPreviousSection();
                    }
                }
            });
        });

        function loadCompetencesData() {
            fetch('/get_competences_data')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.competences && data.competences.ordre_competences) {
                        competences = data.competences.ordre_competences;
                        updateCompetencesDisplay();
                    } else if (data.success && data.etape3_data && data.etape3_data.evaluation_competences && data.etape3_data.evaluation_competences.ordre_competences) {
                        // Fallback to direct access if the nested structure is available
                        competences = data.etape3_data.evaluation_competences.ordre_competences;
                        updateCompetencesDisplay();
                    } else {
                        // Don't show error if competences are already displayed by template
                        const existingCompetences = document.querySelectorAll('#competences-list .competence-item');
                        if (existingCompetences.length === 0) {
                            showError('Aucune comp√©tence trouv√©e. Veuillez d\'abord d√©finir vos comp√©tences.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading competences:', error);
                    // Don't show error if competences are already displayed by template
                    const existingCompetences = document.querySelectorAll('#competences-list .competence-item');
                    if (existingCompetences.length === 0) {
                        showError('Erreur lors du chargement des comp√©tences.');
                    }
                });
        }

        function updateCompetencesDisplay() {
            const listElement = document.getElementById('competences-list');
            
            // Only update if we have competences data
            if (competences && competences.length > 0) {
                let listHTML = '';
                competences.forEach(comp => {
                    const title = comp.titre && String(comp.titre).trim() !== '' ? comp.titre : comp.formulation;
                    const desc = comp.titre && comp.formulation ? comp.formulation : (comp.idees_cles || '');
                    listHTML += `
                        <div class="competence-item">
                            <div class="competence-header">
                                <span class="competence-code">${comp.code}</span>
                                <span class="competence-title">${title || ''}</span>
                            </div>
                            ${desc ? `<div class="competence-desc">${desc}</div>` : ''}
                        </div>
                    `;
                });
                
                listElement.innerHTML = listHTML;
            }
        }

        function loadResourcesCatalog() {
            fetch('/get_resources_catalog')
                .then(r => r.json())
                .then(res => {
                    if (res.success && Array.isArray(res.items)) {
                        resourcesCatalog = res.items;
                    }
                })
                .catch(() => { /* silent */ });
        }

        function normalizeCatalogName(name) {
            if (!name) return '';
            return String(name).trim().toLowerCase();
        }

        function findCatalogEntryByName(name) {
            const target = normalizeCatalogName(displayTitle(name));
            if (!target) return null;
            // direct match on "Nom de l'activit√© ou ressource"
            const exact = resourcesCatalog.find(item => normalizeCatalogName(item['Nom de l\'activit√© ou ressource']) === target);
            if (exact) return exact;
            // fallback: contains
            return resourcesCatalog.find(item => normalizeCatalogName(item['Nom de l\'activit√© ou ressource']).includes(target)) || null;
        }

        function formatCatalogLink(link) {
            if (!link) return '';
            const s = String(link).trim();
            const isUrl = /^https?:\/\//i.test(s);
            if (isUrl) {
                const safe = s.replace(/"/g, '&quot;');
                return `<a href="${safe}" target="_blank" rel="noopener">Voir la documentation</a>`;
            }
            return normalizeValue(s);
        }

        function generateContenus() {
            const generateBtn = document.getElementById('generateContenusBtn');
            const aiLoading = document.getElementById('aiLoading');
            
            // Show loading state
            generateBtn.disabled = true;
            aiLoading.style.display = 'block';
            hideMessages();
            
            // Call the AI generation endpoint
            fetch('/generate_contenus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    contenusData = result.contenus;
                    showAIResults(result.contenus);
                    showSuccess('Contenus g√©n√©r√©s avec succ√®s !');
                } else {
                    showError('Erreur lors de la g√©n√©ration : ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Erreur lors de la g√©n√©ration des contenus.');
            })
            .finally(() => {
                // Reset button state
                generateBtn.disabled = false;
                aiLoading.style.display = 'none';
            });
        }

        // Global variables for detailed view
        let currentSectionIndex = 0;
        let totalSections = 0;

        function showAIResults(contenusData) {
            const aiResultsSection = document.getElementById('aiResultsSection');
            
            // Hide the AI generation section
            document.querySelector('.ai-generate-section').style.display = 'none';
            
            // Show the results section
            aiResultsSection.style.display = 'block';
            
            // Initialize global variables
            totalSections = contenusData.length;
            currentSectionIndex = 0;
            
            // Generate both views
            generateSimplifiedTable(contenusData);
            generateDetailedView(contenusData);
            
            // Show simplified view by default
            switchView('simplified');
            
            // Show submit section
            document.getElementById('submitSection').style.display = 'block';
        }

        function generateSimplifiedTable(contenusData) {
            const simplifiedTableContent = document.getElementById('simplifiedTableContent');
            
            // Determine dynamic columns from data
            let columns = collectDynamicColumns(contenusData);
            // Hide standalone code/titre/niveau fields in simplified table; use only inside competence cell
            columns = columns.filter(c => !['code_competence','titre_competence','niveau_competence'].includes(c));
            
            // Generate simplified table HTML - show ALL sections
            let tableHTML = `
                <table class="simplified-table">
                    <thead>
                        <tr>
                            ${columns.map(col => `<th>${labelForKey(col)}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Add each section to the simplified table (no filtering)
            contenusData.forEach(section => {
                tableHTML += `
                    <tr>
                        ${columns.map(col => {
                            let val;
                            if (col === 'ressource' || col === 'activite_1' || col === 'activite_2') {
                                val = displayTitle(section[col]);
                            } else if (col === 'competences_visees' || col === 'competence_visee') {
                                const compText = normalizeValue(section[col]);
                                const explicitCode = normalizeValue(section.code_competence);
                                const explicitTitle = normalizeValue(section.titre_competence);
                                const explicitLevel = normalizeValue(section.niveau_competence);
                                const code = explicitCode || extractCompetenceCode(compText);
                                const details = getCompetenceDetails(code);
                                const cf = explicitTitle ? { title: explicitTitle, formulation: compText } : getCompetenceTitleAndFormulation(compText, details);
                                val = `<div><strong>${code ? `${code} ‚Äî ` : ''}${cf.title || ''}</strong>${cf.formulation ? `<div>${cf.formulation}</div>` : ''}${explicitLevel ? `<div style=\"font-size:0.85em;color:var(--text-medium);\">Niveau : ${explicitLevel}</div>` : ''}</div>`;
                            } else {
                                val = normalizeValue(section[col]);
                            }
                            const className = (col === 'section') ? 'section-number' :
                                              (col === 'type_de_section' || col === 'type') ? 'section-type' :
                                              (col === 'competences_visees' || col === 'competence_visee') ? 'competence-visee' :
                                              (col.startsWith('activite') ? 'activite' : (col.startsWith('intention') ? 'intention' : (col === 'ressource' ? 'ressource' : '')));
                            return `<td class="${className}">${val || '-'}</td>`;
                        }).join('')}
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            simplifiedTableContent.innerHTML = tableHTML;
        }

        function generateDetailedView(contenusData) {
            const detailedContent = document.getElementById('detailedContent');
            
            // Filter sections to only show those with competences (if present)
            const sectionsWithCompetences = contenusData.filter(section => {
                const cv = normalizeValue(section.competences_visees || section.competence_visee);
                return cv && cv.trim() !== '' && cv !== '-';
            });
            
            // Generate detailed view HTML for filtered sections only
            let detailedHTML = '';
            
            sectionsWithCompetences.forEach((section, index) => {
                detailedHTML += generateSectionCard(section, index);
            });
            
            detailedContent.innerHTML = detailedHTML;
            
            // Update navigation with filtered count
            totalSections = sectionsWithCompetences.length;
            currentSectionIndex = 0;
            updateDetailedNavigation();
        }

        function generateSectionCard(section, index) {
            const competenceText = normalizeValue(section.competences_visees || section.competence_visee);
            const competenceCode = normalizeValue(section.code_competence) || extractCompetenceCode(competenceText);
            const competenceDetails = getCompetenceDetails(competenceCode);
            
            // Known fields handled explicitly; extra fields are ignored per request

            // New: collect top justifications to show at the top of the card
            const topJustifications = [];
            const jr = normalizeValue(section.justification_ressource);
            const ja1 = normalizeValue(section.justification_activite_1);
            const ja2 = normalizeValue(section.justification_activite_2);
            const jas = normalizeValue(section.justification_activite_s);
            if (jr) topJustifications.push({ label: 'Justification ressource', value: jr });
            if (ja1) topJustifications.push({ label: 'Justification activit√© 1', value: ja1 });
            if (ja2) topJustifications.push({ label: 'Justification activit√© 2', value: ja2 });
            if (jas) topJustifications.push({ label: 'Justification activit√©(s)', value: jas });
            
            return `
                <div class="section-card" id="section-${index}" style="display: ${index === 0 ? 'block' : 'none'};">
                    <div class="section-card-header">
                        <h5>${normalizeValue(section.type_de_section || section.type) || 'Section'}</h5>
                        <div class="section-number">${normalizeValue(section.section)}</div>
                    </div>
                    
                    <div class="section-card-content">
                        ${topJustifications.length ? `
                            <div class="justification-box" style="margin-bottom: 16px;">
                                <h6>üí° Justifications</h6>
                                <ul style="margin: 0; padding-left: 18px;">
                                    ${topJustifications.map(j => `<li><strong>${j.label}:</strong> ${j.value}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        <div class="section-info-grid">
                            ${competenceText ? `
                                <div class="section-info-item">
                                    <div class="competence-highlight">${normalizeValue(competenceCode) || 'Comp√©tence'}</div>

                                    ${(() => { const cf = getCompetenceTitleAndFormulation(competenceText, competenceDetails); return `<p><strong>${normalizeValue(competenceCode)} ‚Äî ${normalizeValue(cf.title)}</strong></p>${cf.formulation ? `<p>${normalizeValue(cf.formulation)}</p>` : ''}`; })()}
                                    ${competenceDetails ? `
                                        <div style="margin-top: 10px; padding: 8px; background: rgba(23, 162, 184, 0.1); border-radius: 5px; font-size: 0.9em;">
                                            <strong>Niveau :</strong> ${normalizeValue(competenceDetails.niveau) || 'Non d√©fini'}<br>
                                            <strong>Id√©es cl√©s :</strong> ${normalizeValue(competenceDetails.idees_cles) || 'Non d√©finies'}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            ${normalizeValue(section.ressource) ? `
                                <div class="section-info-item">
                                    <h6>üìö Ressource</h6>
                                    <p><strong>${displayTitle(section.ressource)}</strong></p>
                                    ${normalizeValue(section.intention_ressource) ? `<p><em>Intention : ${normalizeValue(section.intention_ressource)}</em></p>` : ''}
                                    ${(() => { const e = findCatalogEntryByName(section.ressource); return e && e.Description ? `<p style="margin-top:6px; color: var(--text-medium);">${normalizeValue(e.Description)}</p>` : '' })()}
                                    ${(() => { const e = findCatalogEntryByName(section.ressource); return e && e['Type Ressource/ Activit√©'] ? `<p style="margin-top:6px; font-size: 0.9em;">Type : ${normalizeValue(e['Type Ressource/ Activit√©'])}</p>` : '' })()}
                                    ${(() => { const e = findCatalogEntryByName(section.ressource); return e && e['Liens'] ? `<p style=\"margin-top:6px;\">${formatCatalogLink(e['Liens'])}</p>` : '' })()}
                                </div>
                            ` : ''}
                        </div>
                        
                        ${(normalizeValue(section.activite_1) || normalizeValue(section.activite_2)) ? `
                            <div class="section-actions">
                                <h6>üéØ Activit√©s p√©dagogiques</h6>
                                ${normalizeValue(section.activite_1) ? `
                                    <div class="action-item">
                                        <div class="action-icon">1</div>
                                        <div class="action-content">
                                            <div class="action-title">${displayTitle(section.activite_1)}</div>
                                            ${normalizeValue(section.intention_activite_1) ? `<div class="action-intention">Intention : ${normalizeValue(section.intention_activite_1)}</div>` : ''}
                                            ${(() => { const e = findCatalogEntryByName(section.activite_1); return e && e.Description ? `<div style="margin-top:6px; color: var(--text-medium);">${normalizeValue(e.Description)}</div>` : '' })()}
                                            ${(() => { const e = findCatalogEntryByName(section.activite_1); return e && e['Type Ressource/ Activit√©'] ? `<div style=\"margin-top:4px; font-size: 0.85em; color: var(--text-dark);\">Type : ${normalizeValue(e['Type Ressource/ Activit√©'])}</div>` : '' })()}
                                            ${(() => { const e = findCatalogEntryByName(section.activite_1); return e && e['Liens'] ? `<div style=\"margin-top:4px;\">${formatCatalogLink(e['Liens'])}</div>` : '' })()}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${normalizeValue(section.activite_2) ? `
                                    <div class="action-item">
                                        <div class="action-icon">2</div>
                                        <div class="action-content">
                                            <div class="action-title">${displayTitle(section.activite_2)}</div>
                                            ${normalizeValue(section.intention_activite_2) ? `<div class="action-intention">Intention : ${normalizeValue(section.intention_activite_2)}</div>` : ''}
                                            ${(() => { const e = findCatalogEntryByName(section.activite_2); return e && e.Description ? `<div style="margin-top:6px; color: var(--text-medium);">${normalizeValue(e.Description)}</div>` : '' })()}
                                            ${(() => { const e = findCatalogEntryByName(section.activite_2); return e && e['Type Ressource/ Activit√©'] ? `<div style=\"margin-top:4px; font-size: 0.85em; color: var(--text-dark);\">Type : ${normalizeValue(e['Type Ressource/ Activit√©'])}</div>` : '' })()}
                                            ${(() => { const e = findCatalogEntryByName(section.activite_2); return e && e['Liens'] ? `<div style=\"margin-top:4px;\">${formatCatalogLink(e['Liens'])}</div>` : '' })()}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function getCompetenceDetails(competenceCode) {
            if (!competenceCode || !competences) return null;
            
            return competences.find(comp => comp.code === competenceCode) || null;
        }

        function extractCompetenceCode(competenceText) {
            if (!competenceText) return null;
            const match = competenceText.match(/^([A-Z]\d+)/);
            return match ? match[1] : null;
        }

        function switchView(viewType) {
            const simplifiedView = document.getElementById('simplifiedView');
            const detailedView = document.getElementById('detailedView');
            const simplifiedBtn = document.querySelector('.view-option-btn[onclick*="simplified"]');
            const detailedBtn = document.querySelector('.view-option-btn[onclick*="detailed"]');
            
            if (viewType === 'simplified') {
                simplifiedView.style.display = 'block';
                detailedView.style.display = 'none';
                simplifiedBtn.classList.add('active');
                detailedBtn.classList.remove('active');
            } else {
                simplifiedView.style.display = 'none';
                detailedView.style.display = 'block';
                simplifiedBtn.classList.remove('active');
                detailedBtn.classList.add('active');
                updateDetailedNavigation();
            }
        }

        function showNextSection() {
            if (currentSectionIndex < totalSections - 1) {
                document.getElementById(`section-${currentSectionIndex}`).style.display = 'none';
                currentSectionIndex++;
                document.getElementById(`section-${currentSectionIndex}`).style.display = 'block';
                updateDetailedNavigation();
            }
        }

        function showPreviousSection() {
            if (currentSectionIndex > 0) {
                document.getElementById(`section-${currentSectionIndex}`).style.display = 'none';
                currentSectionIndex--;
                document.getElementById(`section-${currentSectionIndex}`).style.display = 'block';
                updateDetailedNavigation();
            }
        }

        function updateDetailedNavigation() {
            const currentSectionNumber = document.getElementById('currentSectionNumber');
            const totalSectionsSpan = document.getElementById('totalSections');
            const prevBtn = document.getElementById('prevSectionBtn');
            const nextBtn = document.getElementById('nextSectionBtn');
            
            currentSectionNumber.textContent = currentSectionIndex + 1;
            totalSectionsSpan.textContent = totalSections;
            
            prevBtn.disabled = currentSectionIndex === 0;
            nextBtn.disabled = currentSectionIndex === totalSections - 1;
        }

        function saveContenus() {
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            
            // Show loading state
            submitBtn.disabled = true;
            loading.style.display = 'block';
            
            // Use the AI generated data directly
            const dataToSave = {
                contenus_par_section: contenusData
            };
            
            // Save to backend
            fetch('/save_contenus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSave)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showSuccess('Contenus sauvegard√©s avec succ√®s !');
                    // Navigate to next step
                    setTimeout(() => {
                        const nextRoute = '{{ nav_info.next_route if nav_info and nav_info.next_route else "" }}';
                        if (nextRoute) {
                            window.location.href = nextRoute;
                        }
                    }, 1500);
                } else {
                    showError('Erreur lors de la sauvegarde : ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Erreur lors de la sauvegarde.');
            })
            .finally(() => {
                // Reset button state
                submitBtn.disabled = false;
                loading.style.display = 'none';
            });
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.textContent = message;
            successElement.style.display = 'block';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Navigation functions for the navigation buttons
        function getPreviousRouteFromNavInfo() {
            return '{{ nav_info.previous_route if nav_info and nav_info.previous_route else "" }}';
        }

        function getNextRouteFromNavInfo() {
            return '{{ nav_info.next_route if nav_info and nav_info.next_route else "" }}';
        }
    </script>
</body>
</html>


