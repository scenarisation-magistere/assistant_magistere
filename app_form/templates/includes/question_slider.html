<!-- Question Slider Template -->
<div class="question-slider-container">
    <!-- Progress Bar with Dots -->
    <div class="progress-dots">
        {% for question in questions %}
        <div class="progress-dot {% if loop.index == 1 %}active{% endif %}" 
             data-question="{{ loop.index }}">
            <span class="dot-number">{{ loop.index }}</span>
        </div>
        {% endfor %}
    </div>

    <!-- Question Container -->
    <div class="question-container">
        {% for question in questions %}
        <div class="question-slide {% if loop.index == 1 %}active{% endif %}" id="question-slide-{{ loop.index }}">
            <!-- Question Header -->
            <div class="question-header">
                <h3 class="question-title">{{ question.question }}</h3>
                <div class="question-counter">Question {{ loop.index }} sur {{ questions|length }}</div>
            </div>

            <!-- Question Content -->
            <div class="question-content">
                {% if question.type == 'group' %}
                {% set instructions = question.instructions %}
                {% set instructions_header = 'üìù Rep√®re pratique' %}
                {% include 'includes/blocks/instructions.html' %}

                {% if question.examples_block %}
                {% set example_titre = question.examples_block.titre %}
                {% set example_objectif = question.examples_block.objectif_general %}
                {% include 'includes/blocks/example.html' %}
                {% endif %}

                <div style="margin-top: var(--spacing-lg);"></div>
                <div class="form-field-section">
                    {% for field in question.fields %}
                        {% if field.type == 'text' %}
                            <div class="form-group" style="margin-bottom: var(--spacing-md);">
                                <label for="{{ field.field_name }}"><strong>{{ field.label }}</strong></label>
                                <input type="text" name="{{ field.field_name }}" id="{{ field.field_name }}" placeholder="{{ field.placeholder }}" required>
                            </div>
                        {% elif field.type == 'textarea' %}
                            <div class="form-group">
                                <label for="{{ field.field_name }}"><strong>{{ field.label }}</strong></label>
                                <textarea name="{{ field.field_name }}" id="{{ field.field_name }}" rows="4" placeholder="{{ field.placeholder }}" required></textarea>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                {% set examples = question.examples %}
                {% set field_name = question.field_name %}
                {% include 'includes/blocks/suggestions.html' %}

                <!-- Form Field -->
                {% include 'includes/blocks/question_fields.html' %}
                {% endif %}
            </div>

                         <!-- Navigation Buttons -->
             <div class="question-navigation{% if loop.first %} first{% endif %}">
                 {% if not loop.first %}
                 <button type="button" class="btn-prev-question">
                     ‚Üê Question pr√©c√©dente
                 </button>
                 {% endif %}
                 
                 {% if not loop.last %}
                 <button type="button" class="btn-next-question">
                     Question suivante ‚Üí
                 </button>
                 {% else %}
                 <button type="button" class="btn-submit-all">
                     ‚úÖ Valider et Continuer
                 </button>
                 {% endif %}
             </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
/* Question Slider Styles */
.question-slider-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

/* Progress Dots */
.progress-dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.progress-dot {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    border: 2px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.progress-dot:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
}

.progress-dot.active {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    color: white;
}

.progress-dot.completed {
    background: var(--primary-green);
    border-color: var(--primary-green);
    color: white;
}

.dot-number {
    font-size: var(--font-size-small);
    font-weight: bold;
}

/* Question Container */
.question-container {
    position: relative;
    min-height: 400px;
}

.question-slide {
    display: none;
    animation: fadeIn 0.5s ease-in-out;
}

.question-slide.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}

/* Question Header */
.question-header {
    text-align: left;
    display: block;
    margin-bottom: 16px;
}

.question-title {
    font-size: var(--font-size-xxl);
    color: var(--text-dark);
    margin-bottom: 6px;
    line-height: 1.3;
}

.question-counter {
    color: var(--text-medium);
    font-size: var(--font-size-small);
    display: block;
    margin-top: 2px;
    float: none;
    clear: both;
    text-align: left;
}

/* Question Content */
.question-content {
    margin-bottom: 40px;
}

/* Suggestions Section */
.suggestions-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
    border-left: 4px solid var(--primary-blue);
}

.suggestions-section h4 {
    color: var(--text-dark);
    margin-bottom: 15px;
    font-size: var(--font-size-large);
}

.suggestions-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.suggestion-item {
    background: white;
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: var(--font-size-normal);
    line-height: 1.4;
}

.suggestion-item:hover {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
}

/* Instructions block (reusable) */
.instructions-section {
    background: #f8f9fb;
    border: 1px solid #e7eef6;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 1px 0 rgba(0,0,0,0.02) inset;
}

.instructions-header {
    font-weight: 700;
    color: #243b53;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.instructions-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.instructions-item {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 12px 14px;
    color: #334e68;
}

/* Form Field Section */
.form-field-section {
    margin-top: 20px;
}

.form-field-section input[type="text"],
.form-field-section textarea {
    width: 100%;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    font-size: var(--font-size-normal);
    transition: all 0.3s ease;
    background: white;
}

.form-field-section input[type="text"]:focus,
.form-field-section textarea:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
}

.example-compact {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px 14px;
    font-family: 'Courier New', monospace;
    font-size: var(--font-size-normal);
}

.form-field-section textarea {
    min-height: 120px;
    resize: vertical;
}

/* Radio and Checkbox Groups */
.radio-group,
.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.radio-item,
.checkbox-item {
    background: white;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 12px;
}

.radio-item:hover,
.checkbox-item:hover {
    border-color: var(--primary-blue);
    background: #f8f9fa;
}

.radio-item input[type="radio"],
.checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--primary-blue);
}

.radio-item label,
 .checkbox-item label {
     flex: 1;
     cursor: pointer;
     font-size: var(--font-size-normal);
     line-height: 1.4;
 }

 /* Text Input Container for conditional fields */
 .text-input-container {
     margin-top: var(--spacing-md);
     padding: var(--spacing-md);
     background: var(--light-gray);
     border-radius: var(--radius-small);
     border-left: 4px solid var(--primary-blue);
     animation: slideDown 0.3s ease-out;
 }

 @keyframes slideDown {
     from { opacity: 0; transform: translateY(-10px); }
     to { opacity: 1; transform: translateY(0); }
 }

 .text-input-container input[type="text"] {
     width: 100%;
     padding: 12px;
     border: 2px solid #e9ecef;
     border-radius: 8px;
     font-size: var(--font-size-normal);
     transition: all 0.3s ease;
 }

 .text-input-container input[type="text"]:focus {
     outline: none;
     border-color: var(--primary-blue);
     box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
 }

/* Question Navigation */
.question-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}

.question-navigation.first {
    justify-content: flex-end;
}

.btn-prev-question,
.btn-next-question,
.btn-submit-all {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-prev-question {
    background: #6c757d;
    color: white;
}

.btn-prev-question:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

.btn-next-question {
    background: var(--primary-blue);
    color: white;
}

.btn-next-question:hover {
    background: var(--primary-blue-dark);
    transform: translateY(-2px);
}

.btn-submit-all {
    background: var(--primary-green);
    color: white;
    font-weight: bold;
}

.btn-submit-all:hover {
    background: var(--primary-green-dark);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(32, 191, 107, 0.3);
}

/* Responsive Design */
@media (max-width: 768px) {
    .question-slider-container {
        padding: 15px;
    }
    
    .progress-dots {
        gap: 8px;
    }
    
    .progress-dot {
        width: 35px;
        height: 35px;
    }
    
    .question-title {
        font-size: 1.3rem;
    }
    
    .suggestions-section {
        padding: 15px;
    }
    
    .question-navigation {
        flex-direction: column;
        gap: 15px;
    }
    
    .btn-prev-question,
    .btn-next-question,
    .btn-submit-all {
        width: 100%;
    }
}
</style>

<script type="application/json" id="questionsData">{{ questions|tojson }}</script>
<script>
let currentQuestion = 1;
const questionsRaw = document.getElementById('questionsData') ? document.getElementById('questionsData').textContent : '[]';
const questionData = JSON.parse(questionsRaw || '[]');
const totalQuestions = questionData.length;

// Initialize the slider
document.addEventListener('DOMContentLoaded', function() {
    updateProgressDots();
    updateQuestionCounter();

    // Attach click handlers for dots and buttons (delegated)
    document.querySelectorAll('.progress-dot').forEach(dot => {
        dot.addEventListener('click', function() {
            const n = Number(this.dataset.question || '0');
            if (n) goToQuestion(n);
        });
    });

    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-prev-question')) {
            e.preventDefault();
            previousQuestion();
        } else if (e.target.closest('.btn-next-question')) {
            e.preventDefault();
            nextQuestion();
        } else if (e.target.closest('.btn-submit-all')) {
            e.preventDefault();
            handleSubmitAll();
        } else if (e.target.closest('.suggestion-item') && e.target.closest('.suggestion-item').dataset.field) {
            const el = e.target.closest('.suggestion-item');
            fillSuggestion(el.dataset.field, el.dataset.suggestion || '');
        }
    });
});

// Navigation functions
function goToQuestion(questionNumber) {
    if (questionNumber < 1 || questionNumber > totalQuestions) return;
    
    // Hide current question
    const activeSlide = document.querySelector('.question-slide.active');
    if (activeSlide) activeSlide.classList.remove('active');
    const activeDot = document.querySelector('.progress-dot.active');
    if (activeDot) activeDot.classList.remove('active');
    
    // Show new question
    const newSlide = document.getElementById(`question-slide-${questionNumber}`);
    if (newSlide) newSlide.classList.add('active');
    const newDot = document.querySelector(`[data-question="${questionNumber}"]`);
    if (newDot) newDot.classList.add('active');
    
    currentQuestion = questionNumber;
    updateProgressDots();
    updateQuestionCounter();
}

function nextQuestion() {
    if (currentQuestion < totalQuestions) {
        goToQuestion(currentQuestion + 1);
    }
}

function previousQuestion() {
    if (currentQuestion > 1) {
        goToQuestion(currentQuestion - 1);
    }
}

// Update progress dots based on completion
function updateProgressDots() {
    const dots = document.querySelectorAll('.progress-dot');
    dots.forEach((dot, index) => {
        const q = questionData[index];
        if (isQuestionObjCompleted(q)) {
            dot.classList.add('completed');
        } else {
            dot.classList.remove('completed');
        }
    });
}

// Check if a single field is completed
function isFieldCompleted(fieldName) {
    if (!fieldName) return false;
    // Radio
    const radioButtons = document.querySelectorAll(`input[name="${fieldName}"][type="radio"]`);
    if (radioButtons.length > 0) {
        const checkedRadio = document.querySelector(`input[name="${fieldName}"][type="radio"]:checked`);
        if (checkedRadio) {
            const textInputContainer = document.getElementById(`text-input-${fieldName}`);
            if (textInputContainer && textInputContainer.style.display !== 'none') {
                const textInput = textInputContainer.querySelector('input[type="text"]');
                return !!(textInput && textInput.value.trim() !== '');
            }
            return true;
        }
        return false;
    }
    // Checkbox
    const checkboxes = document.querySelectorAll(`input[name="${fieldName}"][type="checkbox"]`);
    if (checkboxes.length > 0) {
        const checked = document.querySelectorAll(`input[name="${fieldName}"][type="checkbox"]:checked`);
        if (checked.length === 0) return false;
        // If the selection includes an option that requires text input, ensure it's filled
        const currentQuestion = questionData.find(q => q.field_name === fieldName);
        const textInputContainer = document.getElementById(`text-input-${fieldName}`);
        if (currentQuestion && Array.isArray(currentQuestion.text_input_options) && textInputContainer) {
            const selectedValues = Array.from(checked).map(c => c.value);
            const needsText = selectedValues.some(v => currentQuestion.text_input_options.includes(v));
            if (needsText) {
                const textInput = textInputContainer.querySelector('input[type="text"]');
                return !!(textInput && textInput.value.trim() !== '');
            }
        }
        return true;
    }
    // Text/Textarea
    const field = document.getElementById(fieldName);
    if (field) return field.value.trim() !== '';
    return false;
}

// Backward compatible helper
function isQuestionCompleted(fieldName) {
    return isFieldCompleted(fieldName);
}

// New: check completion for question object (supports 'group')
function isQuestionObjCompleted(question) {
    if (!question) return false;
    if (question.type === 'group' && Array.isArray(question.fields)) {
        return question.fields.every(f => isFieldCompleted(f.field_name));
    }
    if (question.field_name) {
        return isFieldCompleted(question.field_name);
    }
    return false;
}

// Get field name(s) for a question number
function getFieldNameForQuestion(questionNumber) {
    const q = questionData[questionNumber - 1];
    if (!q) return '';
    if (q.type === 'group' && Array.isArray(q.fields)) {
        return q.fields.map(f => f.field_name).join(',');
    }
    return q.field_name || '';
}

// Update question counter
function updateQuestionCounter() {
    const counter = document.querySelector('.question-counter');
    if (counter) {
        counter.textContent = `Question ${currentQuestion} sur ${totalQuestions}`;
    }
}

// Fill suggestion
function fillSuggestion(fieldName, suggestion) {
    const field = document.getElementById(fieldName);
    if (field) {
        field.value = suggestion;
        field.focus();
        updateProgressDots();
    }
}

// Submit all questions
function submitAllQuestions() {
    const incompleteQuestions = [];
    questionData.forEach((question, index) => {
        if (!isQuestionObjCompleted(question)) {
            incompleteQuestions.push(index + 1);
        }
    });
    if (incompleteQuestions.length > 0) {
        alert(`Veuillez compl√©ter les questions suivantes : ${incompleteQuestions.join(', ')}`);
        goToQuestion(incompleteQuestions[0]);
        return;
    }
    document.getElementById('questionnaireForm').submit();
}

// Validate and show YAML
function handleSubmitAll() {
    const incompleteQuestions = [];
    questionData.forEach((question, index) => {
        if (!isQuestionObjCompleted(question)) {
            incompleteQuestions.push(index + 1);
        }
    });
    if (incompleteQuestions.length > 0) {
        alert(`Veuillez compl√©ter les questions suivantes : ${incompleteQuestions.join(', ')}`);
        goToQuestion(incompleteQuestions[0]);
        return;
    }
    const form = document.getElementById('questionnaireForm');
    if (!form) return;
    const endpoint = form.dataset.endpoint || '';
    const data = processFormData('questionnaireForm');
    if (endpoint) {
        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
            if (res && res.success) {
                showSuccessModal(res);
            } else {
                throw new Error(res && res.error ? res.error : 'Erreur lors de la sauvegarde');
            }
        })
        .catch(err => {
            alert('Erreur: ' + err.message);
        });
    } else {
        form.submit();
    }
}

// Show YAML modal
function showYAMLModal(data) {
    const modalHTML = `
        <div id="yamlModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000;">
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 80%; max-height: 80%; overflow-y: auto; position: relative;">
                <h2 style="margin-bottom: 20px; color: #333;">üìÑ YAML G√©n√©r√©</h2>
                <pre style="background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; overflow-x: auto; white-space: pre-wrap; border: 1px solid #dee2e6;">${JSON.stringify(data, null, 2)}</pre>
                <div style="display: flex; justify-content: space-between; margin-top: 20px; gap: 15px;">
                    <button onclick="closeYAMLModal()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">Fermer</button>
                    <button onclick="submitAndContinue()" style="padding: 12px 24px; background: linear-gradient(135deg, #20bf6b 0%, #0fb9b1 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">Continuer vers la page suivante</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeYAMLModal() {
    const modal = document.getElementById('yamlModal');
    if (modal) modal.remove();
}

function submitAndContinue() {
    closeYAMLModal();
    document.getElementById('questionnaireForm').submit();
}

// Handle text input visibility for radio buttons
function handleRadioChange() {
    const radioButtons = document.querySelectorAll('input[type="radio"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            const fieldName = this.name;
            const textInputContainer = document.getElementById(`text-input-${fieldName}`);
            if (textInputContainer) {
                const selectedOption = this.value;
                const currentQuestion = questionData.find(q => q.field_name === fieldName);
                if (currentQuestion && currentQuestion.text_input_options) {
                    const needsTextInput = currentQuestion.text_input_options.includes(selectedOption);
                    textInputContainer.style.display = needsTextInput ? 'block' : 'none';
                    if (needsTextInput) {
                        const labelEl = document.getElementById(`text-label-${fieldName}`);
                        const inputEl = textInputContainer.querySelector('input');
                        if (labelEl && currentQuestion.text_placeholder_map && currentQuestion.text_placeholder_map[selectedOption]) {
                            labelEl.textContent = currentQuestion.text_placeholder_map[selectedOption] + ' :';
                        }
                        if (inputEl && currentQuestion.text_placeholder_map && currentQuestion.text_placeholder_map[selectedOption]) {
                            inputEl.placeholder = currentQuestion.text_placeholder_map[selectedOption];
                        }
                    } else {
                        const textInput = textInputContainer.querySelector('input');
                        if (textInput) textInput.value = '';
                    }
                }
            }
            setTimeout(updateProgressDots, 100);
        });
    });
}

// Handle text input visibility for checkbox groups when specific options are selected
function handleCheckboxChange() {
    const checkboxGroupsByName = new Map();
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        const name = cb.name;
        if (!checkboxGroupsByName.has(name)) checkboxGroupsByName.set(name, []);
        checkboxGroupsByName.get(name).push(cb);
    });
    checkboxGroupsByName.forEach((cbs, name) => {
        cbs.forEach(cb => {
            cb.addEventListener('change', () => {
                const currentQuestion = questionData.find(q => q.field_name === name);
                const textInputContainer = document.getElementById(`text-input-${name}`);
                if (!currentQuestion || !Array.isArray(currentQuestion.text_input_options) || !textInputContainer) {
                    setTimeout(updateProgressDots, 100);
                    return;
                }
                const selectedValues = cbs.filter(x => x.checked).map(x => x.value);
                const needsText = selectedValues.some(v => currentQuestion.text_input_options.includes(v));
                textInputContainer.style.display = needsText ? 'block' : 'none';
                if (!needsText) {
                    const input = textInputContainer.querySelector('input[type="text"]');
                    if (input) input.value = '';
                }
                setTimeout(updateProgressDots, 100);
            });
        });
    });
}

// Add event listeners for real-time progress updates
document.addEventListener('input', function(e) {
    if (e.target.name) setTimeout(updateProgressDots, 100);
});

document.addEventListener('change', function(e) {
    if (e.target.name) setTimeout(updateProgressDots, 100);
});

document.addEventListener('click', function(e) {
    if (e.target.type === 'radio' || e.target.type === 'checkbox') {
        setTimeout(updateProgressDots, 100);
    }
});

document.addEventListener('DOMContentLoaded', function() {
    handleRadioChange();
    handleCheckboxChange();
    const radioInputs = document.querySelectorAll('input[type="radio"]');
    const checkboxInputs = document.querySelectorAll('input[type="checkbox"]');
    radioInputs.forEach(input => input.addEventListener('change', () => setTimeout(updateProgressDots, 100)));
    checkboxInputs.forEach(input => input.addEventListener('change', () => setTimeout(updateProgressDots, 100)));
});
</script>
