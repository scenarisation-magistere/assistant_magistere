
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compétences Visées - Formation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation.css') }}">
    <style>
        /* Page-specific styles for competences.html */
        .header {
            background: var(--gradient-success);
        }

        .step-indicator .step.active {
            color: var(--primary-green);
        }

        .public-cible-recall {
            background: var(--bg-info-light);
            padding: var(--spacing-lg);
            border-radius: var(--radius-small);
            margin-bottom: var(--spacing-xl);
            border-left: 4px solid var(--primary-blue);
        }

        /* Ensure dynamic recap text inherits a variable-based size */
        .public-cible-recall,
        .public-cible-recall .data-item,
        .public-cible-recall .data-item span {
            font-size: var(--font-size-normal);
        }

        .public-cible-recall h3 {
            color: var(--primary-blue);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-xl);
        }

        .public-cible-recall .data-item {
            margin: var(--spacing-sm) 0;
            padding: var(--spacing-sm);
            background: rgba(255,255,255,0.5);
            border-radius: 5px;
        }

        .public-cible-recall .data-item strong {
            color: var(--primary-blue);
        }

        /* Tag list styling for recap lists */
        .data-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .data-tags .tag {
            background: #fff;
            border: 1px solid var(--primary-blue);
            color: var(--primary-blue);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: var(--font-size-small);
            line-height: 1.8;
        }

        /* Layout for context recap (public cible + contraintes) */
        .context-recall-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-xs);
            align-items: start;
            margin-bottom: var(--spacing-lg);
        }

        @media (max-width: 900px) {
            .context-recall-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Accordion styles for recap context */
        .accordion-card {
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-small);
            background: var(--white);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-light);
        }
        .accordion-header {
            width: 100%;
            background: linear-gradient(135deg, var(--light-gray) 0%, var(--medium-gray) 100%);
            color: var(--text-dark);
            border: none;
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-weight: 600;
            font-size: var(--font-size-large);
        }
        .accordion-title { display: inline-flex; align-items: center; gap: 8px; }
        .accordion-chevron { transition: transform 0.2s ease; }
        .accordion-header[aria-expanded="false"] .accordion-chevron { transform: rotate(-90deg); }
        .accordion-panel { padding: var(--spacing-md) var(--spacing-lg) var(--spacing-lg); }

        .contraintes-recall {
            background: var(--bg-info-light);
            padding: var(--spacing-lg);
            border-radius: var(--radius-small);
            margin-bottom: var(--spacing-xl);
            border-left: 4px solid var(--primary-blue);
        }

        /* Ensure dynamic contraintes recap text uses variables too */
        .contraintes-recall,
        .contraintes-recall .data-item,
        .contraintes-recall .data-item span {
            font-size: var(--font-size-normal);
        }

        .contraintes-recall h3 {
            color: var(--primary-blue);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-xl);
        }

        .contraintes-recall .data-item {
            margin: var(--spacing-sm) 0;
            padding: var(--spacing-sm);
            background: rgba(255,255,255,0.5);
            border-radius: 5px;
        }

        .contraintes-recall .data-item strong {
            color: var(--primary-blue);
        }

        /* Two-column fields inside each recap */
        .recap-fields-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 20px;
        }
        @media (max-width: 900px) {
            .recap-fields-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Tight data rows inside recap */
        .recap-fields-grid .data-item {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 8px;
            margin: 0;
            padding: 0;
            background: transparent;
            font-size: var(--font-size-normal);
        }
        @media (max-width: 900px) {
            .recap-fields-grid .data-item {
                grid-template-columns: 1fr;
            }
        }
        .recap-fields-grid .data-item.wide {
            grid-column: 1 / -1;
        }

        /* Two-column blocks for remaining fields */
        .recap-pairs-grid {
            column-count: 2;
            column-gap: 24px;
            margin-top: 6px;
        }
        @media (max-width: 900px) {
            .recap-pairs-grid { column-count: 1; }
        }
        .recap-pairs-grid .data-item {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 8px;
            margin: 0 0 10px 0;
            padding: 0;
            background: transparent;
            break-inside: avoid;
            -webkit-column-break-inside: avoid;
            page-break-inside: avoid;
            font-size: var(--font-size-normal);
        }
        @media (max-width: 900px) {
            .recap-pairs-grid .data-item {
                grid-template-columns: 1fr;
            }
        }
        .recap-pairs-grid .data-item.wide { grid-column: 1 / -1; }

        .competence-section {
            margin: var(--spacing-xxl) 0;
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-medium);
            overflow: hidden;
            position: relative;
        }

        .competence-header {
            background: linear-gradient(135deg, var(--light-gray) 0%, var(--medium-gray) 100%);
            padding: var(--spacing-lg);
            border-bottom: 2px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .competence-header h3 {
            color: var(--secondary-gray-dark);
            font-size: var(--font-size-xl);
            margin-bottom: 0;
        }

        .remove-competence-btn {
            background: var(--gradient-danger);
            color: var(--white);
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius-circle);
            cursor: pointer;
            font-size: var(--font-size-large);
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .remove-competence-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);
        }

        .competence-content {
            padding: var(--spacing-xl);
        }

        .step-group {
            margin: var(--spacing-xl) 0;
            padding: var(--spacing-lg);
            background: var(--light-gray);
            border-radius: var(--radius-small);
            border-left: 4px solid var(--primary-green);
        }

        .step-group h4 {
            color: var(--primary-green);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-large);
        }

        .step-group p {
            color: var(--text-medium);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-small);
        }

        .form-group {
            margin: var(--spacing-md) 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: var(--font-size-normal);
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #20bf6b;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-option:hover {
            border-color: #20bf6b;
            background: #f8f9fa;
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
        }

        .radio-option input[type="radio"]:checked + label {
            color: #20bf6b;
            font-weight: 600;
        }

        .add-competence-section {
            text-align: center;
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px dashed #20bf6b;
        }

        .add-competence-btn {
            background: linear-gradient(135deg, #20bf6b 0%, #0fb9b1 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: var(--font-size-xl);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(32, 191, 107, 0.3);
        }

        .add-competence-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(32, 191, 107, 0.4);
        }

        .ai-suggestion-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: var(--font-size-small);
            border-radius: 20px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .ai-suggestion-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);
        }

        .submit-section {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            border-radius: 15px;
        }

        .submit-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .evaluate-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: var(--font-size-normal);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);
        }

        .evaluate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        }

        .evaluate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .submit-btn {
            background: linear-gradient(135deg, #20bf6b 0%, #0fb9b1 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: var(--font-size-xl);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(32, 191, 107, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(32, 191, 107, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #20bf6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        /* Confirm modal (reuses .modal-content, .save-btn, .cancel-btn styles) */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .yaml-output {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: var(--font-size-small);
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .filename-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }

        .filename-info strong {
            color: #2e7d32;
        }

        .ai-suggestions-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            border: 2px solid #e0e0e0;
        }

        .ai-suggestions-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .ai-suggestions-header h3 {
            color: #6f42c1;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .ai-suggestions-header p {
            color: #666;
            margin-bottom: 20px;
        }

        .ai-generate-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: var(--font-size-normal);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(111, 66, 193, 0.3);
        }

        .ai-generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.4);
        }

        .ai-generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ai-loading {
            text-align: center;
            margin: 30px 0;
        }

        .ai-loading p {
            color: #666;
            margin-top: 15px;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        /* Force two-column layout specifically inside the suggestions pool */
        .suggestions-pool-section .suggestions-grid {
            grid-template-columns: 1fr 1fr;
            align-items: stretch;
        }
        @media (max-width: 900px) {
            .suggestions-pool-section .suggestions-grid {
                grid-template-columns: 1fr;
            }
        }

        .suggestion-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .suggestion-card:hover {
            border-color: #6f42c1;
            box-shadow: 0 5px 15px rgba(111, 66, 193, 0.1);
        }

        .suggestion-card h4 {
            color: #6f42c1;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .suggestion-field {
            margin: 12px 0;
        }

        .suggestion-field label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 5px;
            font-size: var(--font-size-small);
        }

        .suggestion-field .field-value {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #6f42c1;
            font-size: var(--font-size-small);
            color: #555;
        }

        .suggestion-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .apply-suggestion-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: var(--font-size-small);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .apply-suggestion-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
        }

        .ai-actions {
            text-align: center;
            margin-top: 25px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .apply-all-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: var(--font-size-normal);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .apply-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .clear-suggestions-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: var(--font-size-normal);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-suggestions-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .ai-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .error-message {
            color: #721c24;
            font-weight: 600;
        }

        .fallback-notice {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f57c00;
            color: #f57c00;
            font-weight: 600;
        }

        .fallback-banner {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fallback-banner span {
            background: #f57c00;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .fallback-banner p {
            font-size: 0.9em;
            margin-top: 5px;
        }

        .active-competences-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            border: 2px solid #e0e0e0;
        }

        .active-competences-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .active-competences-header h3 {
            color: #20bf6b;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .active-competences-header p {
            color: #666;
            margin-bottom: 20px;
        }

        .active-competences-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .edit-modal .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        /* Bloom Taxonomy Styles */
        .bloom-verbs-container {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .bloom-verbs-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .bloom-level {
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #20bf6b;
        }

        .bloom-level-title {
            color: #20bf6b;
            font-size: 1.1em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .bloom-level-description {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 12px;
            font-style: italic;
        }

        .bloom-verbs-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .bloom-verb-btn {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .bloom-verb-btn:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
        }

        .bloom-verb-btn:active {
            transform: translateY(0);
        }

        .bloom-verb-btn.selected {
            background: #1976d2;
            color: #ffffff;
            border-color: #1976d2;
        }

        .bloom-verb-btn.affective {
            background: #fce4ec;
            color: #c2185b;
            border-color: #f8bbd9;
        }

        .bloom-verb-btn.affective:hover {
            background: #c2185b;
            color: white;
            box-shadow: 0 2px 8px rgba(194, 24, 91, 0.3);
        }

        .bloom-verb-btn.affective.selected {
            background: #c2185b;
            color: #ffffff;
            border-color: #c2185b;
        }

        .bloom-selected-tags {
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .bloom-selected-tags .tag {
            background: #1976d2;
            color: #fff;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.75em;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .save-btn, .cancel-btn {
            padding: 10px 25px;
            font-size: 1em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .cancel-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
        }

        .cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .add-empty-competence-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.9em;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(79, 70, 229, 0.3);
        }

        .add-empty-competence-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
        }

        .suggestions-pool-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            border: 2px solid #e0e0e0;
        }

        .suggestions-pool-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .suggestions-pool-header h3 {
            color: #6f42c1;
            margin-bottom: 10px;
            font-size: var(--font-size-xl);
        }

        .suggestions-pool-header p {
            color: #666;
            margin-bottom: 20px;
        }

        .pool-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .add-new-competence-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: var(--font-size-normal);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(79, 70, 229, 0.3);
        }

        .add-new-competence-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
        }

        .delete-suggestion-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: var(--font-size-small);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .delete-suggestion-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .pool-actions-bottom {
            text-align: center;
            margin-top: 25px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .suggestions-pool-content {
            display: block;
        }

        .selected-competences-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            border: 2px solid #20bf6b;
        }

        .selected-competences-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .selected-competences-header h3 {
            color: #20bf6b;
            margin-bottom: 10px;
            font-size: var(--font-size-xl);
        }

        .selected-competences-header p {
            color: #666;
            margin-bottom: 20px;
        }

        .selection-counter {
            text-align: center;
            margin-top: 6px;
            color: #666;
            font-size: var(--font-size-normal);
        }

        .selected-actions {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .evaluation-actions {
            display: flex;
            justify-content: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .evaluate-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: var(--font-size-normal);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);
            font-weight: 600;
        }

        .evaluate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }

        .evaluate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .remove-all-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.9em;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .remove-all-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content-container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .radio-group {
                gap: 5px;
            }

            .radio-option {
                padding: 8px;
            }
        }

        .evaluation-results-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            border: 2px solid #17a2b8;
        }

        .evaluation-results-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .evaluation-results-header h3 {
            color: #17a2b8;
            margin-bottom: 10px;
            font-size: var(--font-size-xl);
        }

        .evaluation-results-header p {
            color: #666;
            margin-bottom: 20px;
        }

        /* Intro explanation in evaluation results */
        .evaluation-intro {
            margin: 10px auto 0;
            text-align: left;
            max-width: 900px;
            color: #495057;
        }
        .evaluation-intro p { margin-bottom: 8px; }
        .evaluation-intro ol { padding-left: 18px; margin: 0; }
        .evaluation-intro li { margin: 6px 0; }

        .evaluation-results-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .competence-evaluation {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .competence-evaluation:hover {
            border-color: #17a2b8;
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.1);
        }

        .competence-evaluation h4 {
            color: #17a2b8;
            margin-bottom: 15px;
            font-size: var(--font-size-large);
        }

        .competence-formulation {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            margin: 10px 0 15px 0;
            font-style: italic;
            color: #555;
            font-size: var(--font-size-normal);
            line-height: 1.4;
        }

        .competence-evaluation p {
            color: #666;
            margin: 8px 0;
            font-size: var(--font-size-normal);
        }

        .competence-evaluation strong {
            color: #333;
        }

        .competences-manquantes {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .competences-manquantes h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .competence-suggestion {
            background: white;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .competence-suggestion h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .suggestion-details p {
            margin: 8px 0;
            color: #666;
        }

        .avis-global {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .avis-global h3 {
            color: #0c5460;
            margin-bottom: 15px;
        }

        .points-amelioration {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .points-amelioration h3 {
            color: #721c24;
            margin-bottom: 15px;
        }

        .points-amelioration ul {
            margin: 0;
            padding-left: 20px;
        }

                .points-amelioration li {
            margin: 8px 0;
            color: #721c24;
        }

        .avis-global h3 {
            color: #17a2b8;
            margin-bottom: 15px;
        }

        .points-amelioration {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .points-amelioration h3 {
            color: #17a2b8;
            margin-bottom: 15px;
        }

        .points-amelioration ul {
            list-style-type: none;
            padding: 0;
        }

        .points-amelioration li {
            background: #f8f9fa;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            color: #666;
        }

        .evaluation-actions {
            text-align: center;
            margin: 25px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }

        .evaluation-loading {
            text-align: center;
            margin: 20px 0;
        }

        .evaluation-loading p {
            color: #666;
            margin-top: 15px;
        }

        /* Nicer explanation above evaluate button */
        .evaluation-explanation {
            max-width: 900px;
            margin: 0 auto 12px auto;
            width: 100%;
        }
        .evaluation-explanation p {
            text-align: center;
            margin: 0 0 10px 0;
            color: #495057;
            font-weight: 600;
        }
        .evaluation-explanation ul {
            list-style: none;
            padding: 0;
            margin: 0 auto;
            max-width: 900px;
            width: 100%;
        }
        .evaluation-explanation li {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 8px 0;
            color: #333;
            line-height: 1.5;
        }
        .evaluation-explanation li::before {
            content: '✔';
            color: #17a2b8;
            background: #e8f7fb;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            flex: 0 0 24px;
        }
        .evaluation-actions { width: 100%; }
        .evaluation-actions .evaluate-btn { margin-top: 6px; }
        .selected-competences-section .evaluation-actions { flex-direction: column; align-items: center; }
        .evaluation-explanation ul { max-width: 720px; }
        .evaluation-explanation li { white-space: normal; word-break: normal; overflow-wrap: break-word; }

        .competences-manquantes {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .competences-manquantes h3 {
            color: #ff6b35;
            margin-bottom: 15px;
        }

        .competences-manquantes > p {
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
        }

        .competence-suggestion {
            background: #fff8f0;
            border: 2px solid #ff6b35;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .competence-suggestion h4 {
            color: #ff6b35;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .suggestion-details p {
            color: #666;
            margin: 8px 0;
            font-size: 0.95em;
        }

        .suggestion-details strong {
            color: #333;
        }

        .evaluation-status-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .evaluation-status-notice .notice-content p {
            color: #856404;
            margin: 0;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        {% include 'includes/header.html' %}

        <div class="content-container">
            <!-- Instruction panel moved above recap -->
            {% set instructions_header = 'Objectif de cette étape' %}
            {% set instructions_subtitle = "Définissez les compétences clés qui structureront la formation." %}
            {% set instructions = [
                "Formuler 3 compétences principales (une 4e étant optionnelle) selon le scénario CMO.",
                "Choisir entre deux modes : IA (génère 4 compétences modifiables) ou pas à pas (créer vous-même les compétences).",
                "Sélectionner les verbes en cliquant sur les tags proposés : ils se colorent lorsqu’ils sont choisis et s’affichent sous forme de pastilles. Cliquez à nouveau pour les retirer.",
                "Chaque compétence doit inclure au moins un verbe cognitif et un verbe affectif (Bloom révisée).",
                "Indiquer un niveau de complexité (bas, moyen, haut) pour chaque domaine.",
                "Contextualiser la compétence (cadre, situation, public)."
            ] %}
            {% set instructions_footer = "Astuce : commencez par une formulation simple, puis raffinez avec les niveaux Bloom." %}
            {% from 'includes/blocks/components.html' import instructions_panel %}
            {{ instructions_panel(instructions_header, instructions_subtitle, instructions, instructions_footer) }}

            <!-- Recap accordion -->
            <div class="accordion-card">
                <button type="button" class="accordion-header" id="recapToggleBtn" aria-expanded="false" aria-controls="recapSection">
                    <span class="accordion-title">📌 Contexte (Public cible & Contraintes)</span>
                    <span class="accordion-chevron">▾</span>
                </button>
                <div id="recapSection" class="accordion-panel" style="display: none;">
                <div class="context-recall-grid">
                <div class="public-cible-recall">
                    <h3> Titre, objectif et public cible</h3>
                    <div class="recap-fields-grid">
                    <div class="data-item wide">
                        <strong>Titre de formation :</strong> <span id="titre-formation">{{ public_cible_data.titre_formation if public_cible_data and public_cible_data.titre_formation else 'Non défini' }}</span>
                    </div>
                    <div class="data-item wide">
                        <strong>Objectif général :</strong> <span id="objectif-general">{{ public_cible_data.objectif_general if public_cible_data and public_cible_data.objectif_general else 'Non défini' }}</span>
                    </div>
                    <div class="data-item">
                        <strong>Type de public :</strong> <span id="type-public">
                            {% if public_cible_data and public_cible_data.type_de_public %}
                                {% if public_cible_data.type_de_public is string %}
                                    {{ public_cible_data.type_de_public }}
                                {% else %}
                                    <span class="data-tags">
                                        {% for p in public_cible_data.type_de_public %}
                                            <span class="tag">{{ p }}</span>
                                        {% endfor %}
                                    </span>
                                {% endif %}
                            {% else %}
                                Non défini
                            {% endif %}
                        </span>
                    </div>
                    </div>
                    <div class="recap-pairs-grid">
                        <div class="data-item">
                        <strong>Type de formation :</strong>
                        <span>
                            {% if public_cible_data and public_cible_data.type_de_formation %}
                                {{ public_cible_data.type_de_formation }}{% if public_cible_data.type_de_formation_precisions %} — {{ public_cible_data.type_de_formation_precisions }}{% endif %}
                            {% else %}
                                Non défini
                            {% endif %}
                        </span>
                        </div>
                        <div class="data-item">
                        <strong>Niveaux scolaires :</strong>
                        <span>
                            {% if public_cible_data and public_cible_data.niveaux_scolaires %}
                                {% if public_cible_data.niveaux_scolaires is string %}
                                    {{ public_cible_data.niveaux_scolaires }}
                                {% else %}
                                    <span class="data-tags">
                                        {% for n in public_cible_data.niveaux_scolaires %}
                                            <span class="tag">{{ n }}</span>
                                        {% endfor %}
                                    </span>
                                {% endif %}
                            {% else %}
                                Non défini
                            {% endif %}
                        </span>
                        </div>
                        <div class="data-item">
                        <strong>Niveau d'expertise :</strong> <span id="niveau-expertise">
                            {% if public_cible_data and public_cible_data.niveau_expertise %}
                                {% if public_cible_data.niveau_expertise is string %}
                                    {{ public_cible_data.niveau_expertise }}
                                {% else %}
                                    <span class="data-tags">
                                        {% for n in public_cible_data.niveau_expertise %}
                                            <span class="tag">{{ n }}</span>
                                        {% endfor %}
                                    </span>
                                {% endif %}
                            {% else %}
                                Non défini
                            {% endif %}
                        </span>
                        </div>
                        <div class="data-item wide">
                        <strong>Besoins spécifiques :</strong>
                        <span>
                            {% if public_cible_data and public_cible_data.besoins_specifiques %}
                                {% if public_cible_data.besoins_specifiques is string %}
                                    {{ public_cible_data.besoins_specifiques }}
                                {% else %}
                                    <span class="data-tags">
                                        {% for b in public_cible_data.besoins_specifiques %}
                                            <span class="tag">{{ b }}</span>
                                        {% endfor %}
                                    </span>
                                {% endif %}
                            {% else %}
                                Aucun
                            {% endif %}
                        </span>
                        </div>
                    </div>
                </div>

                <div class="contraintes-recall">
                    <h3> Contraintes Formation</h3>
                    <div class="recap-fields-grid">
                    <div class="data-item">
                        <strong>Nombre de participants :</strong>
                        <span>{{ contraintes_data.nombre_participants if contraintes_data and contraintes_data.nombre_participants else 'Non défini' }}</span>
                    </div>
                    <div class="data-item">
                        <strong>Animation :</strong>
                        <span>{{ contraintes_data.animation if contraintes_data and contraintes_data.animation else 'Non défini' }}</span>
                    </div>
                    <div class="data-item">
                        <strong>Exigences institutionnelles :</strong>
                        <span>{{ contraintes_data.exigences_institutionnelles if contraintes_data and contraintes_data.exigences_institutionnelles else 'Non défini' }}</span>
                    </div>
                    <div class="data-item">
                        <strong>Restrictions techniques :</strong>
                        <span>{{ contraintes_data.restrictions_techniques if contraintes_data and contraintes_data.restrictions_techniques else 'Non défini' }}</span>
                    </div>
                    </div>
                </div>
                </div>
            </div>
            </div>

            

            <!-- Ideas Workshop Section (AI + Manual Drafts) -->
            <div class="suggestions-pool-section">
                <div class="suggestions-pool-header">
                    <h3>🎨 Atelier d'Idées</h3>
                    <p>Créez des brouillons de compétences avant de les ajouter à votre formation</p>
                    <div class="pool-actions">
                        <button class="ai-generate-btn" onclick="generateAISuggestions()" id="aiGenerateBtn">
                            ✨ Génération IA
                        </button>
                        <button class="add-new-competence-btn" onclick="addNewCompetence()">
                            ✏️ Création pas à pas
                        </button>
                    </div>
                </div>
                
                <div class="ai-loading" id="aiLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Génération des suggestions en cours...</p>
                </div>
                
                <div class="suggestions-pool-content" id="suggestionsPoolContent">
                    <div class="suggestions-grid" id="suggestionsGrid">
                        <!-- AI suggestions and new competences will be inserted here -->
                    </div>
                    
                    <div class="pool-actions-bottom" id="poolActionsBottom" style="display: none;"></div>
                </div>
                
                <div class="ai-error" id="aiError" style="display: none;">
                    <div class="error-message" id="aiErrorMessage"></div>
                </div>
            </div>

            <!-- Selected Competences Pool Section -->
            <div class="selected-competences-section" id="selectedCompetencesSection">
                <div class="selected-competences-header">
                    <h3>📋 Compétences Sélectionnées</h3>
                    <p>Compétences choisies pour votre formation</p>
                    <p class="selection-counter" id="selectionCounter">0/4 compétences sélectionnées —  nécessaire : 3</p>
                    <div class="selected-actions" id="selectedActions" style="display: none;">
                        <button class="remove-all-btn" onclick="removeAllCompetences()">
                            ➖ Retirer Toutes
                        </button>
                    </div>
                </div>
                
                <div class="selected-competences-content">
                    <div class="suggestions-grid" id="selectedCompetencesGrid">
                        <!-- Selected competences will be inserted here -->
                    </div>
                </div>
                
                <!-- Evaluation Button - Only shown when competences are present -->
                <div class="evaluation-actions" id="evaluationActions" style="display: none;">
                    <div class="evaluation-explanation">
                        <p>L’assistant va maintenant ordonner et évaluer vos compétences en fonction de leur niveau de difficulté, selon le principe d’alignement de Biggs.</p>

                    </div>
                    <button type="button" id="evaluateBtn" onclick="evaluateCompetences()" class="evaluate-btn">
                        🔍 Ordonner et evaluer
                    </button>
                    <div class="evaluation-loading" id="evaluateLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Évaluation en cours...</p>
                    </div>
                </div>
            </div>

            <!-- Evaluation Results Section -->
            <div class="evaluation-results-section" id="evaluationResultsSection" style="display: none;">
                <div class="evaluation-results-header">
                    <h3>🔍 Résultats de l'Évaluation</h3>
                    <div class="evaluation-intro">
                        <p>L’ordonnancement proposé (selon l’alignement pédagogique de Biggs) repose sur trois principes :</p>
                        <ol>
                            <li><strong>Progressivité</strong> : commencer par les compétences les plus simples ou fondamentales avant d’aborder les plus complexes.</li>
                            <li><strong>Cohérence</strong> : veiller à ce que chaque compétence prépare la suivante (enchaînement logique).</li>
                            <li><strong>Alignement</strong> : faire correspondre objectifs, activités et évaluation pour garantir la pertinence pédagogique.</li>
                        </ol>
                    </div>
                </div>
                
                <div class="evaluation-results-content" id="evaluationResultsContent">
                    <!-- Evaluation results will be inserted here -->
                </div>
            </div>

            <!-- Evaluation Status Notice -->
            <div class="evaluation-status-notice" id="evaluationStatusNotice" style="display: none;">
                <div class="notice-content">
                    <p>⚠️ <strong>Évaluation requise :</strong> Vous devez évaluer vos compétences avant de pouvoir continuer.</p>
                </div>
            </div>

            <!-- Hidden form for submission -->
            <form id="competencesForm" style="display: none;">
                <div id="competencesContainer">
                    <!-- Competences will be added here dynamically for form submission -->
                </div>

                <div class="submit-section">
                    <button type="submit" class="submit-btn" id="submitBtn">
                        ✅ Valider et Continuer vers {{ get_page_name_by_step(nav_info.step + 1) }}
                    </button>
                    
                    <div class="loading" id="loading">
                        <div class="loading-spinner"></div>
                        <p>Sauvegarde en cours...</p>
                    </div>
                </div>
            </form>

            <!-- Submit Section (visible) - Only shown when competences are selected and evaluated -->
            <div class="submit-section" id="submitSection" style="margin-top: 40px; display: none;">
                <div class="submit-actions">
                    <button type="button" class="submit-btn" id="visibleSubmitBtn" onclick="prepareAndSubmitForm()">
                        ✅ Valider et Continuer vers {{ get_page_name_by_step(nav_info.step + 1) }}
                    </button>
                </div>
                
                <div class="loading" id="visibleLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Sauvegarde en cours...</p>
                </div>
            </div>

            
        </div>
    </div>
    </div>

    
    <!-- Confirm Replace Workshop Modal -->
    <div class="confirm-modal" id="confirmReplaceModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeConfirmReplaceModal()">&times;</span>
            <h2>⚠️ Remplacer l'atelier d'idées</h2>
            <div>
                <p>L'atelier d'idées contient déjà des compétences.</p>
                <p>En poursuivant, elles seront toutes supprimées. Les nouvelles suggestions seront générées en tenant compte des <strong>compétences sélectionnées</strong>.</p>
                <p>Pour conserver des éléments, ajoutez-les d'abord à <strong>Compétences sélectionnées</strong>.</p>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeConfirmReplaceModal()">Annuler</button>
                <button class="save-btn" onclick="confirmReplaceWorkshop()">Continuer</button>
            </div>
        </div>
    </div>

    {% include 'includes/modals/edit_competence_modal.html' %}

    <script src="{{ url_for('static', filename='js/common_validation.js') }}"></script>
    <script>
        // Accordion behavior for recap
        (function initRecapAccordion(){
            document.addEventListener('DOMContentLoaded', function(){
                const header = document.getElementById('recapToggleBtn');
                const panel = document.getElementById('recapSection');
                if (!header || !panel) return;
                header.addEventListener('click', function(){
                    const expanded = header.getAttribute('aria-expanded') === 'true';
                    header.setAttribute('aria-expanded', (!expanded).toString());
                    panel.style.display = expanded ? 'none' : 'block';
                });
            });
        })();

        // Load previous data from YAML
        let previousData = {% if public_cible_data %}{{ public_cible_data | tojson | safe }}{% else %}null{% endif %};
        let workshopCompetences = []; // Pool (atelier) – includes IA and manual drafts
        let selectedCompetences = []; // Store selected competences
        let competenceCount = {{ competences | length }};
        let competenceIds = new Set(); // Track existing competence IDs
        let evaluationCompleted = false; // Track if evaluation has been completed
        const MAX_SELECTED_COMPETENCES = 4;
        const IDEAL_MIN_SELECTED_COMPETENCES = 3;

        // Override navigation functions for this template
        function getNextRouteFromNavInfo() {
            {% if nav_info and nav_info.next_route %}
                return '{{ nav_info.next_route }}';
            {% endif %}
            return null;
        }

        function getPreviousRouteFromNavInfo() {
            {% if nav_info and nav_info.previous_route %}
                return '{{ nav_info.previous_route }}';
            {% endif %}
            return null;
        }

        // Initialize competence IDs tracking
        document.addEventListener('DOMContentLoaded', function() {
            // Track existing competence IDs
            document.querySelectorAll('.competence-section').forEach(section => {
                const competenceId = section.getAttribute('data-competence-id');
                if (competenceId) {
                    competenceIds.add(competenceId);
                }
            });
            
            // Add change event listeners to all niveau radio buttons
            const niveauRadios = document.querySelectorAll('input[name^="niveau_"]');
            niveauRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const competenceId = this.name.split('_')[1];
                    const selectedNiveau = this.value;
                });
            });
            
            // Initialize displays
            displaySelectedCompetences();
            displaySuggestionsPool();
            updateSubmitButtonVisibility();
        });

        function updateSubmitButtonVisibility() {
            const submitSection = document.getElementById('submitSection');
            const evaluationStatusNotice = document.getElementById('evaluationStatusNotice');
            const evaluationResultsSection = document.getElementById('evaluationResultsSection');
            const hasCompetences = selectedCompetences.length > 0;
            const tooManyCompetences = selectedCompetences.length > MAX_SELECTED_COMPETENCES;
            
            // Show submit button only if competences are selected AND evaluation is completed
            if (hasCompetences && evaluationCompleted && !tooManyCompetences) {
                submitSection.style.display = 'block';
                evaluationStatusNotice.style.display = 'none';
                evaluationResultsSection.style.display = 'block';
            } else if (tooManyCompetences) {
                submitSection.style.display = 'none';
                evaluationStatusNotice.style.display = 'block';
                evaluationResultsSection.style.display = 'none';
                const noticeText = evaluationStatusNotice.querySelector('.notice-content p');
                if (noticeText) {
                    noticeText.innerHTML = "⚠️ <strong>Limite atteinte :</strong> Sélectionnez au maximum 4 compétences pour continuer.";
                }
            } else if (hasCompetences && !evaluationCompleted) {
                // Show evaluation notice when competences are selected but not evaluated
                submitSection.style.display = 'none';
                evaluationStatusNotice.style.display = 'block';
                evaluationResultsSection.style.display = 'none';
                const noticeText = evaluationStatusNotice.querySelector('.notice-content p');
                if (noticeText) {
                    noticeText.innerHTML = "⚠️ <strong>Évaluation requise :</strong> Vous devez évaluer vos compétences avant de pouvoir continuer.";
                }
            } else {
                // Hide both when no competences are selected
                submitSection.style.display = 'none';
                evaluationStatusNotice.style.display = 'none';
                evaluationResultsSection.style.display = 'none';
            }
        }

        function updateSelectionCounter() {
            const counter = document.getElementById('selectionCounter');
            if (!counter) return;
            const count = selectedCompetences.length;
            const idealHint = count < IDEAL_MIN_SELECTED_COMPETENCES ? ` — ajoutez encore ${IDEAL_MIN_SELECTED_COMPETENCES - count} compétence(s) (idéal : 3 à 4)` : ' — idéal : 3 à 4';
            counter.textContent = `${count}/${MAX_SELECTED_COMPETENCES} compétences sélectionnées${idealHint}`;
        }

        function canAddMoreSelected() {
            if (selectedCompetences.length >= MAX_SELECTED_COMPETENCES) {
                showSuccessMessage('Limite atteinte : maximum 4 compétences dans la sélection.');
                return false;
            }
            return true;
        }

        function createCompetenceHTML(competence, competenceNumber) {
            let stepsHtml = '';
            
            // Add title field at the beginning
            stepsHtml += `
                <div class="step-group">
                    <h4>Titre de la compétence</h4>
                    <p>Donnez un titre court et descriptif à cette compétence</p>
                    <div class="form-group">
                        <input type="text" name="titre_${competenceNumber}" placeholder="Ex: Utilisation des outils d'IA" value="${competence.titre || ''}">
                    </div>
                </div>
            `;
            
            competence.steps.forEach((step, stepIndex) => {
                let fieldHtml = '';
                if (step.type === 'textarea') {
                    fieldHtml = `<textarea name="${step.field_name}" placeholder="${step.placeholder}" ${step.step === 4 ? 'readonly' : ''}></textarea>`;
                } else if (step.type === 'text') {
                    fieldHtml = `<input type="text" name="${step.field_name}" placeholder="${step.placeholder}">`;
                } else if (step.type === 'radio') {
                    let optionsHtml = '';
                    step.options.forEach((option, optionIndex) => {
                        optionsHtml += `
                            <div class="radio-option">
                                <input type="radio" name="${step.field_name}" value="${option}" id="${step.field_name}_${optionIndex + 1}">
                                <label for="${step.field_name}_${optionIndex + 1}">${option}</label>
                            </div>
                        `;
                    });
                    fieldHtml = `<div class="radio-group">${optionsHtml}</div>`;
                }
                
                stepsHtml += `
                    <div class="step-group">
                        <h4>Étape ${step.step} – ${step.title}</h4>
                        <p>${step.description}</p>
                        <div class="form-group">
                            ${fieldHtml}
                        </div>
                    </div>
                `;
            });
            
            return `
                <div class="competence-section" data-competence-id="${competence.id}">
                    <div class="competence-header">
                        <h3>${competence.title}</h3>
                        <button type="button" class="remove-competence-btn" onclick="removeCompetence('${competence.id}')" title="Supprimer cette compétence">
                            🗑️
                        </button>
                    </div>
                    <div class="competence-content">
                        ${stepsHtml}
                    </div>
                </div>
            `;
        }



        function generateCompetenceFormulation(competenceId) {
            // Extract number from competence ID if it's a full ID
            const competenceNumber = competenceId.includes('_') ? competenceId.split('_')[1] : competenceId;
            const ideesCles = document.querySelector(`textarea[name="idees_cles_${competenceNumber}"]`)?.value;
            const niveau = document.querySelector(`input[name="niveau_${competenceNumber}"]:checked`)?.value;
            const verbes = document.querySelector(`input[name="verbes_${competenceNumber}"]`)?.value;
            
            if (!ideesCles || !niveau || !verbes) {
                return '';
            }
            
            // Simple formulation generation
            const niveauMap = {
                'Haut': 'créer',
                'Moyen': 'appliquer',
                'Bas': 'identifier'
            };
            
            const actionVerb = niveauMap[niveau] || verbes.split(',')[0].trim();
            return `${actionVerb} ${ideesCles.toLowerCase()}`;
        }

        // Auto-generate formulations when all fields are filled
        document.addEventListener('input', function(e) {
            const fieldName = e.target.name;
            if (fieldName.includes('verbes_')) {
                const competenceId = fieldName.split('_')[1];
                setTimeout(() => {
                    const formulation = generateCompetenceFormulation(competenceId);
                    if (formulation) {
                        const formulationField = document.querySelector(`textarea[name="formulation_${competenceId}"]`);
                        if (formulationField) {
                            formulationField.value = formulation;
                        }
                    }
                }, 500);
            }
        });

        document.getElementById('competencesForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            
            submitBtn.disabled = true;
            loading.style.display = 'block';
            
            const formData = new FormData(this);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Generate formulations for all competencies
            const competenceSections = document.querySelectorAll('.competence-section');
            competenceSections.forEach((section, index) => {
                const competenceId = section.getAttribute('data-competence-id');
                const competenceNumber = competenceId.split('_')[1];
                const formulation = generateCompetenceFormulation(competenceNumber);
                if (formulation) {
                    data[`formulation_${competenceNumber}`] = formulation;
                }
            });
            
            fetch('/submit_competences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Redirect directly to next step
                    const next = getNextRouteFromNavInfo();
                    if (next) {
                        window.location.href = next;
                    } else {
                        showSuccessMessage('Sauvegarde réussie.');
                    }
                } else {
                    alert('Erreur lors de la sauvegarde : ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur lors de la sauvegarde');
            })
            .finally(() => {
                submitBtn.disabled = false;
                loading.style.display = 'none';
            });
        });

        function closeModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('successModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        function addNewCompetence() {
            // Open modal directly for creating a new competence
            const editModalContent = document.getElementById('editModalContent');
            editModalContent.innerHTML = `
                <div class=\"form-group\">
                    <label>Titre de la compétence :</label>
                    <input type=\"text\" id=\"editTitle\" value=\"Nouvelle Compétence\" class=\"form-control\">
                </div>
                <div class=\"form-group\">
                    <label>Niveau cognitif :</label>
                    <select id=\"editNiveauCognitif\" class=\"form-control\" onchange=\"loadVerbsForDomain('cognitif')\">
                        <option value=\"Haut\">Haut</option>
                        <option value=\"Moyen\" selected>Moyen</option>
                        <option value=\"Bas\">Bas</option>
                    </select>
                </div>
                <div class=\"form-group\">
                    <label>Verbes cognitifs :</label>
                    <div id=\"cognitiveVerbsContainer\" class=\"bloom-verbs-container\">
                        <p class=\"bloom-verbs-title\">💡 Sélectionnez des verbes cognitifs (au moins un).</p>
                        <div id=\"cognitiveVerbsList\" class=\"bloom-verbs-list\"></div>
                        <div id=\"selectedCognitiveTags\" class=\"bloom-selected-tags\"></div>
                    </div>
                </div>
                <div class=\"form-group\">
                    <label>Niveau affectif :</label>
                    <select id=\"editNiveauAffectif\" class=\"form-control\" onchange=\"loadVerbsForDomain('affectif')\">
                        <option value=\"Haut\">Haut</option>
                        <option value=\"Moyen\" selected>Moyen</option>
                        <option value=\"Bas\">Bas</option>
                    </select>
                </div>
                <div class=\"form-group\">
                    <label>Verbes affectifs :</label>
                    <div id=\"affectiveVerbsContainer\" class=\"bloom-verbs-container\">
                        <p class=\"bloom-verbs-title\">💡 Sélectionnez des verbes affectifs (au moins un).</p>
                        <div id=\"affectiveVerbsList\" class=\"bloom-verbs-list\"></div>
                        <div id=\"selectedAffectiveTags\" class=\"bloom-selected-tags\"></div>
                    </div>
                </div>
                <div class=\"form-group\">
                    <label>Idées clés :</label>
                    <textarea id=\"editIdeesCles\" class=\"form-control\" placeholder=\"Entrez les idées clés...\"></textarea>
                </div>
                <div class=\"form-group\">
                    <label>Formulation :</label>
                    <textarea id=\"editFormulation\" class=\"form-control\" placeholder=\"Entrez la formulation...\"></textarea>
                </div>
                <input type=\"hidden\" id=\"editCompetenceId\" value=\"new\">
            `;
            
            document.getElementById('editModal').style.display = 'block';
            // Ensure hidden inputs exist and are empty, then load verbs per domain
            const hiddenCog = ensureHiddenVerbsInput('cognitif'); hiddenCog.value = '';
            const hiddenAff = ensureHiddenVerbsInput('affectif'); hiddenAff.value = '';
            loadVerbsForDomain('cognitif');
            loadVerbsForDomain('affectif');
        }

        function generateAISuggestions() {
            // Check if there are competences already in the workshop pool (IA or manual)
            const hasExistingContent = workshopCompetences.length > 0;
            if (hasExistingContent) {
                // Open styled confirmation modal
                openConfirmReplaceModal();
                return; // Generation continues after user confirms
            }
            
            const generateBtn = document.getElementById('aiGenerateBtn');
            const loading = document.getElementById('aiLoading');
            const content = document.getElementById('suggestionsPoolContent');
            const error = document.getElementById('aiError');
            
            // Show loading state
            generateBtn.disabled = true;
            loading.style.display = 'block';
            content.style.display = 'none';
            error.style.display = 'none';
            
            // Clear entire workshop pool
            workshopCompetences = [];
            
            // Call the API
            const payload = {
                selected_competences: selectedCompetences.map(c => ({
                    titre: c.titre || '',
                    idees_cles: c.idees_cles || '',
                    niveau: c.niveau || '',
                    verbes: c.verbes || '',
                    formulation: c.formulation || ''
                })),
                workshop_competences: workshopCompetences.map(c => ({
                    titre: c.titre || '',
                    idees_cles: c.idees_cles || '',
                    niveau: c.niveau || '',
                    verbes: c.verbes || (Array.isArray(c.verbes_suggere) ? c.verbes_suggere.join(', ') : (c.verbes_suggere || '')),
                    formulation: c.formulation || ''
                }))
            };

            fetch('/generate_ai_suggestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Set new suggestions into the unified workshop pool
                    workshopCompetences = (result.suggestions || []).map((sug, idx) => {
                        const vc = Array.isArray(sug.verbes_cognitifs) ? sug.verbes_cognitifs.join(', ') : (sug.verbes_cognitifs || '');
                        const va = Array.isArray(sug.verbes_affectifs) ? sug.verbes_affectifs.join(', ') : (sug.verbes_affectifs || '');
                        const combinedVerbs = [vc, va].filter(Boolean).join(', ');
                        const nc = sug.niveau_cognitif || '';
                        const na = sug.niveau_affectif || '';
                        const combinedLevel = (nc || na) ? `Cog: ${nc || '?'} / Aff: ${na || '?'}` : '';
                        return {
                            id: `ws_${Date.now()}_${idx}`,
                            titre: sug.titre || `Compétence ${idx + 1}`,
                            idees_cles: sug.idees_cles || '',
                            niveau: combinedLevel,
                            niveau_cognitif: nc,
                            niveau_affectif: na,
                            verbes: combinedVerbs,
                            verbes_cognitifs: vc,
                            verbes_affectifs: va,
                            formulation: sug.formulation || '',
                            source: 'ai'
                        };
                    });
                    displaySuggestionsPool();
                    content.style.display = 'block';
                } else {
                    showAIError(result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAIError('Erreur lors de la génération des suggestions');
            })
            .finally(() => {
                // Reset button state
                generateBtn.disabled = false;
                loading.style.display = 'none';
            });
        }

        function displaySuggestionsPool() {
            const grid = document.getElementById('suggestionsGrid');
            const actionsBottom = document.getElementById('poolActionsBottom');
            grid.innerHTML = '';

            let hasContent = false;

            // Display unified workshop competences
            if (workshopCompetences.length > 0) {
                workshopCompetences.forEach((item) => {
                    hasContent = true;
                    const card = document.createElement('div');
                    card.className = 'suggestion-card';

                    card.innerHTML = `
                        <h4>${item.titre || 'Compétence'}</h4>
                        <div class="suggestion-field">
                            <label>Idées clés :</label>
                            <div class="field-value">${item.idees_cles || 'Non spécifié'}</div>
                        </div>
                        <div class="suggestion-field">
                            <label>Niveau :</label>
                            <div class="field-value">${item.niveau || 'Non spécifié'}</div>
                        </div>
                        <div class="suggestion-field">
                            <label>Verbes :</label>
                            <div class="field-value">${item.verbes || (Array.isArray(item.verbes_suggere) ? item.verbes_suggere.join(', ') : (item.verbes_suggere || 'Non spécifié'))}</div>
                        </div>
                        <div class="suggestion-field">
                            <label>Formulation :</label>
                            <div class="field-value">${item.formulation || 'Non spécifié'}</div>
                        </div>
                        <div class="suggestion-actions">
                            <button class="apply-suggestion-btn" onclick="addWorkshopItemToSelected('${item.id}')">➕ Ajouter</button>
                            <button class="apply-suggestion-btn" onclick="editWorkshopItem('${item.id}')" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">✏️ Modifier</button>
                            <button class="delete-suggestion-btn" onclick="deleteWorkshopItem('${item.id}')" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">🗑️ Supprimer</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            // Show/hide bottom actions
            actionsBottom.style.display = hasContent ? 'flex' : 'none';
        }

        function updateActiveCompetencesDisplay() {
            const activeSection = document.getElementById('activeCompetencesSection');
            const activeGrid = document.getElementById('activeCompetencesGrid');
            const competenceSections = document.querySelectorAll('.competence-section');
            
            if (competenceSections.length === 0) {
                activeSection.style.display = 'none';
                return;
            }
            
            activeSection.style.display = 'block';
            activeGrid.innerHTML = '';
            
            competenceSections.forEach((section, index) => {
                const competenceId = section.getAttribute('data-competence-id');
                const title = section.querySelector('h3').textContent;
                
                // Get competence data
                const ideesCles = section.querySelector('textarea[name^="idees_cles_"]')?.value || '';
                const niveau = section.querySelector('input[name^="niveau_"]:checked')?.value || '';
                const verbes = section.querySelector('input[name^="verbes_"]')?.value || '';
                const formulation = section.querySelector('textarea[name^="formulation_"]')?.value || '';
                
                const card = document.createElement('div');
                card.className = 'suggestion-card';
                card.innerHTML = `
                    <h4>${title}</h4>
                    <div class="suggestion-field">
                        <label>Idées clés :</label>
                        <div class="field-value">${ideesCles || 'Non spécifié'}</div>
                    </div>
                    <div class="suggestion-field">
                        <label>Niveau :</label>
                        <div class="field-value">${niveau || 'Non spécifié'}</div>
                    </div>
                    <div class="suggestion-field">
                        <label>Verbes :</label>
                        <div class="field-value">${verbes || 'Non spécifié'}</div>
                    </div>
                    <div class="suggestion-field">
                        <label>Formulation :</label>
                        <div class="field-value">${formulation || 'Non spécifié'}</div>
                    </div>
                    <div class="suggestion-actions">
                        <button class="apply-suggestion-btn" onclick="editCompetence('${competenceId}')" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                            ✏️ Modifier
                        </button>
                        <button class="apply-suggestion-btn" onclick="removeCompetence('${competenceId}')" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                            🗑️ Supprimer
                        </button>
                    </div>
                `;
                activeGrid.appendChild(card);
            });
        }

        function addCompetence() {
            return fetch('/add_competence', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    competenceCount = result.competence_count;
                    const competence = result.competence;
                    
                    // Check if competence ID already exists
                    if (competenceIds.has(competence.id)) {
                        // Reorder competences to fix numbering
                        return reorderCompetences();
                    }
                    
                    // Add to tracking set
                    competenceIds.add(competence.id);
                    
                    // Create new competence HTML
                    const competenceHtml = createCompetenceHTML(competence, competenceCount);
                    
                    // Insert before the add competence section
                    const addSection = document.querySelector('.add-competence-section');
                    addSection.insertAdjacentHTML('beforebegin', competenceHtml);
                    
                    // Update active competences display
                    updateActiveCompetencesDisplay();
                    
                    showSuccessMessage('Nouvelle compétence ajoutée !');
                    return result;
                } else {
                    alert('Erreur lors de l\'ajout de la compétence : ' + result.error);
                    throw new Error(result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur lors de l\'ajout de la compétence');
                throw error;
            });
        }

        function removeCompetence(competenceId) {
            // Find the competence in selected competences
            const competenceIndex = selectedCompetences.findIndex(c => c.id === competenceId);
            if (competenceIndex === -1) return;
            
            const competence = selectedCompetences[competenceIndex];
            
            // Return competence to unified workshop pool
            workshopCompetences.push({
                id: `ws_${Date.now()}`,
                titre: competence.titre,
                idees_cles: competence.idees_cles,
                niveau: competence.niveau,
                verbes: competence.verbes,
                formulation: competence.formulation,
                source: 'selected'
            });
            showSuccessMessage('Compétence retirée et retournée à l\'atelier d\'idées !');
            
            // Remove from selected competences
            selectedCompetences.splice(competenceIndex, 1);
            
            // Update displays
            displaySelectedCompetences();
            displaySuggestionsPool();
        }

        function reorderCompetences() {
            // Get current competences from DOM
            const competenceSections = document.querySelectorAll('.competence-section');
            const currentCompetences = [];
            
            competenceSections.forEach(section => {
                const competenceId = section.getAttribute('data-competence-id');
                const title = section.querySelector('h3').textContent;
                currentCompetences.push({
                    id: competenceId,
                    title: title
                });
            });
            
            // Call backend to reorder
            return fetch('/reorder_competences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    competences: currentCompetences
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update the DOM with reordered competences
                    updateCompetencesDisplay(result.competences);
                    competenceCount = result.competence_count;
                    return result;
                } else {
                    console.error('Error reordering competences:', result.error);
                    return result;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                return { success: false, error: error.message };
            });
        }

        function updateCompetencesDisplay(reorderedCompetences) {
            const container = document.getElementById('competencesContainer');
            const addSection = document.querySelector('.add-competence-section');
            
            // Clear existing competences
            container.innerHTML = '';
            
            // Add reordered competences
            reorderedCompetences.forEach(competence => {
                const competenceHtml = createCompetenceHTML(competence, competence.competence_number);
                container.insertAdjacentHTML('beforeend', competenceHtml);
            });
            
            // Update tracking set
            competenceIds.clear();
            reorderedCompetences.forEach(competence => {
                competenceIds.add(competence.id);
            });
            
            // Update active competences display
            updateActiveCompetencesDisplay();
        }

        function applySuggestion(index) {
            if (!aiSuggestions[index] || usedSuggestionIndices.has(index)) return;
            if (!canAddMoreSelected()) {
                return;
            }
            
            const suggestion = aiSuggestions[index];
            
            // Mark this suggestion as used
            usedSuggestionIndices.add(index);
            
            // Create new competence with the AI suggestion data
            const newCompetenceId = `competence_${competenceCount + 1}`;
            const newCompetence = {
                id: newCompetenceId,
                titre: suggestion.titre || `Compétence ${competenceCount + 1}`,
                idees_cles: suggestion.idees_cles || '',
                niveau: suggestion.niveau || '',
                verbes: Array.isArray(suggestion.verbes_suggere) ? suggestion.verbes_suggere.join(', ') : suggestion.verbes_suggere || '',
                formulation: suggestion.formulation || '',
                type: 'ai',
                suggestionIndex: index
            };
            
            // Add to selected competences
            selectedCompetences.push(newCompetence);
            competenceCount++;
            competenceIds.add(newCompetenceId);
            
            // Update displays
            displaySelectedCompetences();
            displaySuggestionsPool();
            
            showSuccessMessage('Compétence ajoutée à votre formation !');
        }

        function applyAllSuggestions() {
            // Apply all available suggestions
            aiSuggestions.forEach((suggestion, index) => {
                if (!usedSuggestionIndices.has(index)) {
                    applySuggestion(index);
                }
            });
            showSuccessMessage('Tous les brouillons disponibles ont été ajoutés à votre formation !');
        }

        function clearSuggestions() {
            const confirmed = confirm('Êtes-vous sûr de vouloir supprimer toutes les compétences (atelier d\'idées ET formation) ? Cette action est irréversible.');
            if (!confirmed) {
                return;
            }
            
            // Clear everything
            aiSuggestions = [];
            newCompetences = [];
            selectedCompetences = [];
            usedSuggestionIndices.clear();
            
            // Reset evaluation status
            evaluationCompleted = false;
            
            // Update displays
            displaySelectedCompetences();
            displaySuggestionsPool();
            
            showSuccessMessage('Toutes les compétences ont été supprimées !');
        }

        function showAIError(message) {
            const error = document.getElementById('aiError');
            const errorMessage = document.getElementById('aiErrorMessage');
            errorMessage.textContent = message;
            error.style.display = 'block';
        }

        // Styled confirm modal control
        function openConfirmReplaceModal() {
            const modal = document.getElementById('confirmReplaceModal');
            modal.style.display = 'block';
        }
        function closeConfirmReplaceModal() {
            const modal = document.getElementById('confirmReplaceModal');
            modal.style.display = 'none';
        }
        function confirmReplaceWorkshop() {
            closeConfirmReplaceModal();
            // Proceed with generation after clearing workshop
            const generateBtn = document.getElementById('aiGenerateBtn');
            const loading = document.getElementById('aiLoading');
            const content = document.getElementById('suggestionsPoolContent');
            const error = document.getElementById('aiError');

            generateBtn.disabled = true;
            loading.style.display = 'block';
            content.style.display = 'none';
            error.style.display = 'none';

            // Snapshot current workshop items to inform the backend
            const workshopSnapshot = workshopCompetences.slice();
            // Then clear the workshop for fresh generation
            workshopCompetences = [];

            const payload = {
                selected_competences: selectedCompetences.map(c => ({
                    titre: c.titre || '',
                    idees_cles: c.idees_cles || '',
                    niveau: c.niveau || '',
                    verbes: c.verbes || '',
                    formulation: c.formulation || ''
                })),
                workshop_competences: workshopSnapshot.map(c => ({
                    titre: c.titre || '',
                    idees_cles: c.idees_cles || '',
                    niveau: c.niveau || '',
                    verbes: c.verbes || (Array.isArray(c.verbes_suggere) ? c.verbes_suggere.join(', ') : (c.verbes_suggere || '')),
                    formulation: c.formulation || ''
                }))
            };

            fetch('/generate_ai_suggestions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    workshopCompetences = (result.suggestions || []).map((sug, idx) => {
                        const vc = Array.isArray(sug.verbes_cognitifs) ? sug.verbes_cognitifs.join(', ') : (sug.verbes_cognitifs || '');
                        const va = Array.isArray(sug.verbes_affectifs) ? sug.verbes_affectifs.join(', ') : (sug.verbes_affectifs || '');
                        const combinedVerbs = [vc, va].filter(Boolean).join(', ');
                        const nc = sug.niveau_cognitif || '';
                        const na = sug.niveau_affectif || '';
                        const combinedLevel = (nc || na) ? `Cog: ${nc || '?'} / Aff: ${na || '?'}` : '';
                        return {
                            id: `ws_${Date.now()}_${idx}`,
                            titre: sug.titre || `Compétence ${idx + 1}`,
                            idees_cles: sug.idees_cles || '',
                            niveau: combinedLevel,
                            niveau_cognitif: nc,
                            niveau_affectif: na,
                            verbes: combinedVerbs,
                            verbes_cognitifs: vc,
                            verbes_affectifs: va,
                            formulation: sug.formulation || '',
                            source: 'ai'
                        };
                    });
                    displaySuggestionsPool();
                    content.style.display = 'block';
                } else {
                    showAIError(result.error);
                }
            })
            .catch(e => {
                console.error('Error:', e);
                showAIError('Erreur lors de la génération des suggestions');
            })
            .finally(() => {
                generateBtn.disabled = false;
                loading.style.display = 'none';
            });
        }

        function showSuccessMessage(message) {
            // Create a temporary success message
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            // Remove after 3 seconds
            setTimeout(() => {
                document.body.removeChild(successDiv);
            }, 3000);
        }

        function applySuggestionToCompetence(competenceId, suggestion) {
            // Extract number from competence ID
            const competenceNumber = competenceId.split('_')[1];
            
            // Apply to form fields
            const ideesClesField = document.querySelector(`textarea[name="idees_cles_${competenceNumber}"]`);
            const verbesField = document.querySelector(`input[name="verbes_${competenceNumber}"]`);
            const formulationField = document.querySelector(`textarea[name="formulation_${competenceNumber}"]`);
            
            if (ideesClesField && suggestion.idees_cles) {
                ideesClesField.value = suggestion.idees_cles;
            }
            
            if (verbesField && suggestion.verbes_suggere) {
                const verbes = Array.isArray(suggestion.verbes_suggere) ? suggestion.verbes_suggere.join(', ') : suggestion.verbes_suggere;
                verbesField.value = verbes;
            }
            
            if (formulationField && suggestion.formulation) {
                formulationField.value = suggestion.formulation;
            }
            
            // Set radio button for niveau
            if (suggestion.niveau) {
                const niveauOptions = document.querySelectorAll(`input[name="niveau_${competenceNumber}"]`);
                niveauOptions.forEach(option => {
                    if (option.value.includes(suggestion.niveau)) {
                        option.checked = true;
                    }
                });
            }
            
            // Update the competence title with the short title
            const titleElement = document.querySelector(`[data-competence-id="${competenceId}"] h3`);
            if (titleElement && suggestion.titre) {
                titleElement.textContent = suggestion.titre;
            }
            
            // Show success message
            showSuccessMessage(`Suggestion appliquée à ${competenceId} !`);
        }

        function editCompetence(competenceId) {
            // Find the competence in selected competences
            const competence = selectedCompetences.find(c => c.id === competenceId);
            if (!competence) return;
            
            const editModalContent = document.getElementById('editModalContent');
            editModalContent.innerHTML = `
                <div class=\"form-group\">
                    <label>Titre de la compétence :</label>
                    <input type=\"text\" id=\"editTitle\" value=\"${competence.titre}\" class=\"form-control\">
                </div>
                <div class=\"form-group\">
                    <label>Niveau :</label>
                    <select id=\"editNiveau\" class=\"form-control\" onchange=\"loadBloomVerbs()\">
                        <optgroup label=\"Cognitif\">
                            <option value=\"Haut : Créer / Évaluer\" ${competence.niveau === 'Haut : Créer / Évaluer' ? 'selected' : ''}>Haut : Créer / Évaluer</option>
                            <option value=\"Moyen : Appliquer / Analyser\" ${competence.niveau === 'Moyen : Appliquer / Analyser' ? 'selected' : ''}>Moyen : Appliquer / Analyser</option>
                            <option value=\"Bas : Comprendre / Connaître\" ${competence.niveau === 'Bas : Comprendre / Connaître' ? 'selected' : ''}>Bas : Comprendre / Connaître</option>
                        </optgroup>
                        <optgroup label=\"Affectif\">
                            <option value=\"Affectif : Réception\" ${competence.niveau === 'Affectif : Réception' ? 'selected' : ''}>Affectif : Réception</option>
                            <option value=\"Affectif : Réponse\" ${competence.niveau === 'Affectif : Réponse' ? 'selected' : ''}>Affectif : Réponse</option>
                            <option value=\"Affectif : Valorisation\" ${competence.niveau === 'Affectif : Valorisation' ? 'selected' : ''}>Affectif : Valorisation</option>
                            <option value=\"Affectif : Organisation\" ${competence.niveau === 'Affectif : Organisation' ? 'selected' : ''}>Affectif : Organisation</option>
                            <option value=\"Affectif : Caractérisation\" ${competence.niveau === 'Affectif : Caractérisation' ? 'selected' : ''}>Affectif : Caractérisation</option>
                        </optgroup>
                    </select>
                </div>
                <div class=\"form-group\">
                    <label>Verbes :</label>
                    <div id=\"bloomVerbsContainer\" class=\"bloom-verbs-container\">
                        <p class=\"bloom-verbs-title\">💡 Sélectionnez des verbes en cliquant sur les tags (cliquer à nouveau pour retirer).</p>
                        <div id=\"bloomVerbsList\" class=\"bloom-verbs-list\">
                            <!-- Les verbes seront chargés ici -->
                        </div>
                        <div id=\"selectedVerbsTags\" class=\"bloom-selected-tags\"></div>
                    </div>
                </div>
                <div class=\"form-group\">
                    <label>Idées clés :</label>
                    <textarea id=\"editIdeesCles\" class=\"form-control\">${competence.idees_cles}</textarea>
                </div>
                <div class=\"form-group\">
                    <label>Formulation :</label>
                    <textarea id=\"editFormulation\" class=\"form-control\">${competence.formulation}</textarea>
                </div>
                <input type=\"hidden\" id=\"editCompetenceId\" value=\"${competenceId}\">
            `;
            
            document.getElementById('editModal').style.display = 'block';
            // Replace niveau selector with simple Bas/Moyen/Haut options
            (function(){
                const sel = document.getElementById('editNiveau');
                if (sel) {
                    const current = competence.niveau && ['Bas','Moyen','Haut'].includes(competence.niveau) ? competence.niveau : null;
                    sel.innerHTML = '<option value="Haut">Haut</option><option value="Moyen">Moyen</option><option value="Bas">Bas</option>';
                    if (current) sel.value = current;
                }
            })();
            
            // Prepare hidden input with existing verbs and load verbs
            const hidden = ensureHiddenVerbsInput();
            hidden.value = competence.verbes || '';
            loadBloomVerbs();
        }

        function addStepToCompetence(competenceId) {
            const editModalContent = document.getElementById('editModalContent');
            const stepCount = editModalContent.querySelectorAll('.step-group').length;
            const newStepNumber = stepCount + 1;

            editModalContent.innerHTML += `
                <div class="step-group">
                    <h4>Étape ${newStepNumber} – Nouveau Titre</h4>
                    <input type="text" name="step_${stepCount}_title" placeholder="Titre de l'étape">
                    <textarea name="step_${stepCount}_description" placeholder="Description de l'étape"></textarea>
                    <div class="form-group">
                        <label>Type d'étape :</label>
                        <select name="step_${stepCount}_type">
                            <option value="textarea">Texte</option>
                            <option value="text">Texte simple</option>
                            <option value="radio">Choix multiple</option>
                        </select>
                    </div>
                    <button type="button" class="remove-step-btn" onclick="removeStepFromCompetence('${competenceId}', ${stepCount})">🗑️ Supprimer l'étape</button>
                </div>
            `;
        }

        function removeStepFromCompetence(competenceId, stepIndex) {
            const editModalContent = document.getElementById('editModalContent');
            const steps = editModalContent.querySelectorAll('.step-group');
            if (steps.length > 1) {
                steps[stepIndex].remove();
                // Re-number steps after removal
                editModalContent.querySelectorAll('.step-group').forEach((group, index) => {
                    group.querySelector('h4').textContent = `Étape ${index + 1} – ${group.querySelector('h4').textContent.split(' – ')[1]}`;
                });
            }
        }

        function saveCompetenceEdit() {
            const competenceId = document.getElementById('editCompetenceId').value;
            
            if (competenceId === 'new') {
                // Creating a new competence
                const newCompetenceId = `competence_${competenceCount + 1}`;
                const newCompetence = {
                    id: newCompetenceId,
                    titre: document.getElementById('editTitle').value,
                    idees_cles: document.getElementById('editIdeesCles').value,
                    niveau: `Cog: ${document.getElementById('editNiveauCognitif').value} / Aff: ${document.getElementById('editNiveauAffectif').value}`,
                    niveau_cognitif: document.getElementById('editNiveauCognitif').value,
                    niveau_affectif: document.getElementById('editNiveauAffectif').value,
                    verbes: [ensureHiddenVerbsInput('cognitif').value, ensureHiddenVerbsInput('affectif').value].filter(Boolean).join(', '),
                    verbes_cognitifs: ensureHiddenVerbsInput('cognitif').value,
                    verbes_affectifs: ensureHiddenVerbsInput('affectif').value,
                    formulation: document.getElementById('editFormulation').value,
                    type: 'new'
                };
                
                // Add to unified workshop pool
                workshopCompetences.push({ ...newCompetence, id: `ws_${Date.now()}` });
                competenceCount++;
                competenceIds.add(newCompetenceId);
                
                // Update display
                displaySuggestionsPool();
                
                showSuccessMessage('Brouillon créé dans l\'atelier d\'idées !');
            } else {
                if (competenceId.startsWith('ws:')) {
                    // Editing a workshop item
                    const wsId = competenceId.split(':')[1];
                    const item = workshopCompetences.find(i => i.id === wsId);
                    if (item) {
                        item.titre = document.getElementById('editTitle').value;
                        item.idees_cles = document.getElementById('editIdeesCles').value;
                        item.niveau_cognitif = document.getElementById('editNiveauCognitif').value;
                        item.niveau_affectif = document.getElementById('editNiveauAffectif').value;
                        item.niveau = `Cog: ${item.niveau_cognitif} / Aff: ${item.niveau_affectif}`;
                        item.verbes_cognitifs = ensureHiddenVerbsInput('cognitif').value;
                        item.verbes_affectifs = ensureHiddenVerbsInput('affectif').value;
                        item.verbes = [item.verbes_cognitifs, item.verbes_affectifs].filter(Boolean).join(', ');
                        item.formulation = document.getElementById('editFormulation').value;
                        displaySuggestionsPool();
                        showSuccessMessage('Brouillon mis à jour !');
                        closeEditModal();
                        return;
                    }
                }
                // Editing existing competence
                const competence = selectedCompetences.find(c => c.id === competenceId);
                if (!competence) return;
                
                // Update competence data
                competence.titre = document.getElementById('editTitle').value;
                competence.idees_cles = document.getElementById('editIdeesCles').value;
                competence.niveau_cognitif = document.getElementById('editNiveauCognitif').value;
                competence.niveau_affectif = document.getElementById('editNiveauAffectif').value;
                competence.niveau = `Cog: ${competence.niveau_cognitif} / Aff: ${competence.niveau_affectif}`;
                competence.verbes_cognitifs = ensureHiddenVerbsInput('cognitif').value;
                competence.verbes_affectifs = ensureHiddenVerbsInput('affectif').value;
                competence.verbes = [competence.verbes_cognitifs, competence.verbes_affectifs].filter(Boolean).join(', ');
                competence.formulation = document.getElementById('editFormulation').value;
                
                // Reset evaluation status since competence was modified
                evaluationCompleted = false;
                
                // Update display
                displaySelectedCompetences();
                
                showSuccessMessage('Compétence modifiée avec succès ! L\'évaluation doit être relancée.');
            }
            
            closeEditModal();
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function loadVerbsForDomain(domain) {
            const levelSelectId = domain === 'cognitif' ? 'editNiveauCognitif' : 'editNiveauAffectif';
            const listId = domain === 'cognitif' ? 'cognitiveVerbsList' : 'affectiveVerbsList';
            const levelSelect = document.getElementById(levelSelectId);
            const verbsList = document.getElementById(listId);
            if (!levelSelect || !verbsList) return;
            const selectedLevel = levelSelect.value;
            verbsList.innerHTML = '<p>Chargement des verbes...</p>';
            fetch(`/get_verbs_by_domain_level?domain=${encodeURIComponent(domain)}&level=${encodeURIComponent(selectedLevel)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const flat = [];
                        Object.values(data.verbs || {}).forEach(v => {
                            (v.verbs || []).forEach(x => flat.push(x));
                        });
                        displayDomainVerbs(domain, flat);
                    } else {
                        verbsList.innerHTML = '<p class="error">Erreur lors du chargement des verbes</p>';
                    }
                })
                .catch(() => {
                    verbsList.innerHTML = '<p class="error">Erreur de connexion</p>';
                });
        }

        function displayDomainVerbs(domain, verbs) {
            const listId = domain === 'cognitif' ? 'cognitiveVerbsList' : 'affectiveVerbsList';
            const tagsId = domain === 'cognitif' ? 'selectedCognitiveTags' : 'selectedAffectiveTags';
            const listBox = document.getElementById(listId);
            const selectedTags = document.getElementById(tagsId);
            if (!listBox) return;
            let html = '';
            html += '<div class="bloom-level">';
            html += '<div class="bloom-verbs-grid">';
            verbs.forEach(verb => {
                const cls = domain === 'affectif' ? 'bloom-verb-btn affective' : 'bloom-verb-btn';
                html += `<button type="button" class="${cls}" data-verb="${verb}" data-domain="${domain}" onclick="toggleBloomVerb(this)">${verb}</button>`;
            });
            html += '</div></div>';
            listBox.innerHTML = html;
            // Rehydrate from hidden input
            const hidden = ensureHiddenVerbsInput(domain);
            if (hidden && hidden.value) {
                const selected = hidden.value.split(',').map(v => v.trim()).filter(Boolean);
                const buttons = listBox.querySelectorAll('.bloom-verb-btn');
                buttons.forEach(btn => {
                    if (selected.includes(btn.getAttribute('data-verb'))) {
                        btn.classList.add('selected');
                    }
                });
                renderSelectedTags(selected, domain);
            } else if (selectedTags) {
                selectedTags.innerHTML = '';
            }
        }

        // Maintain verbs in a hidden input to keep backend unchanged
        // Create it on demand in the modal
        function ensureHiddenVerbsInput(domain) {
            const id = domain === 'cognitif' ? 'editVerbesCognitifs' : 'editVerbesAffectifs';
            let hidden = document.getElementById(id);
            if (!hidden) {
                hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.id = id;
                hidden.value = '';
                const container = domain === 'cognitif' ? document.getElementById('cognitiveVerbsContainer') : document.getElementById('affectiveVerbsContainer');
                if (container) container.prepend(hidden);
            }
            return hidden;
        }

        function renderSelectedTags(list, domain) {
            const box = domain === 'cognitif' ? document.getElementById('selectedCognitiveTags') : document.getElementById('selectedAffectiveTags');
            if (!box) return;
            box.innerHTML = '';
            list.forEach(v => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = v;
                box.appendChild(tag);
            });
        }

        function toggleBloomVerb(button) {
            const verb = button.getAttribute('data-verb');
            const domain = button.getAttribute('data-domain') || (button.classList.contains('affective') ? 'affectif' : 'cognitif');
            const hidden = ensureHiddenVerbsInput(domain);
            let list = hidden.value ? hidden.value.split(',').map(v => v.trim()).filter(Boolean) : [];
            const idx = list.indexOf(verb);
            if (idx >= 0) {
                list.splice(idx, 1);
                button.classList.remove('selected');
            } else {
                list.push(verb);
                button.classList.add('selected');
            }
            hidden.value = list.join(', ');
            renderSelectedTags(list, domain);
        }

        // No initialization needed - all competences will have remove buttons

        function displaySelectedCompetences() {
            const selectedSection = document.getElementById('selectedCompetencesSection');
            const selectedGrid = document.getElementById('selectedCompetencesGrid');
            const selectedActions = document.getElementById('selectedActions');
            const evaluationActions = document.getElementById('evaluationActions');
            const evaluateBtn = document.getElementById('evaluateBtn');
            
            // Always show the section
            selectedSection.style.display = 'block';
            selectedGrid.innerHTML = '';
            
            // Show/hide the remove all button and evaluation button based on competences count
            if (selectedCompetences.length > 0) {
                selectedActions.style.display = 'flex';
                // Show evaluation block only when 3 to 4 competences are selected
                if (selectedCompetences.length >= IDEAL_MIN_SELECTED_COMPETENCES && selectedCompetences.length <= MAX_SELECTED_COMPETENCES) {
                    evaluationActions.style.display = 'block';
                } else {
                    evaluationActions.style.display = 'none';
                }
            } else {
                selectedActions.style.display = 'none';
                evaluationActions.style.display = 'none';
            }
            // Disable evaluate button if none selected or too many
            if (evaluateBtn) {
                evaluateBtn.disabled = (selectedCompetences.length < IDEAL_MIN_SELECTED_COMPETENCES) || (selectedCompetences.length > MAX_SELECTED_COMPETENCES);
            }
            
            if (selectedCompetences.length === 0) {
                // Show empty state
                const emptyCard = document.createElement('div');
                emptyCard.className = 'suggestion-card';
                emptyCard.innerHTML = `
                    <h4>Aucune compétence sélectionnée</h4>
                    <p>Ajoutez des compétences depuis l'atelier d'idées pour commencer votre formation.</p>
                `;
                selectedGrid.appendChild(emptyCard);
                // Reset evaluation status when no competences are selected
                evaluationCompleted = false;
                updateSubmitButtonVisibility();
                return;
            }
            
            selectedCompetences.forEach((competence, index) => {
                const card = document.createElement('div');
                card.className = 'suggestion-card';
                const competenceNumber = index + 1;
                const competenceCode = `C${competenceNumber}`;
                
                card.innerHTML = `
                    <h4>${competenceCode} - ${competence.titre}</h4>
                    <div class="suggestion-field">
                        <label>Idées clés :</label>
                        <div class="field-value">${competence.idees_cles || 'Non spécifié'}</div>
                    </div>
                    <div class="suggestion-field">
                        <label>Niveau :</label>
                        <div class="field-value">${competence.niveau || 'Non spécifié'}</div>
                    </div>
                    <div class="suggestion-field">
                        <label>Verbes :</label>
                        <div class="field-value">${competence.verbes || 'Non spécifié'}</div>
                    </div>
                    <div class="suggestion-field">
                        <label>Formulation :</label>
                        <div class="field-value">${competence.formulation || 'Non spécifié'}</div>
                    </div>
                    <div class="suggestion-actions">
                        <button class="apply-suggestion-btn" onclick="removeCompetence('${competence.id}')" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                            ➖ Retirer
                        </button>
                    </div>
                `;
                selectedGrid.appendChild(card);
            });
            
            // Update the selection counter and submit button visibility
            updateSelectionCounter();
            updateSubmitButtonVisibility();
        }

        function prepareAndSubmitForm() {
            // Use harmonized submit button approach
            const submitHandler = createHarmonizedSubmitButton({
                buttonId: 'visibleSubmitBtn',
                buttonText: '✅ Valider et Continuer vers {{ get_page_name_by_step(nav_info.step + 1) }}',
                endpoint: '/submit_competences',
                dataProcessor: () => {
                    // Prepare data from selected competences
                    const data = {};
                    selectedCompetences.forEach((competence, index) => {
                        const competenceNumber = index + 1;
                        data[`titre_${competenceNumber}`] = competence.titre || `Compétence ${competenceNumber}`;
                        data[`idees_cles_${competenceNumber}`] = competence.idees_cles;
                        data[`niveau_${competenceNumber}`] = competence.niveau;
                        data[`niveau_cognitif_${competenceNumber}`] = competence.niveau_cognitif || '';
                        data[`niveau_affectif_${competenceNumber}`] = competence.niveau_affectif || '';
                        data[`verbes_${competenceNumber}`] = competence.verbes;
                        data[`verbes_cognitifs_${competenceNumber}`] = competence.verbes_cognitifs || '';
                        data[`verbes_affectifs_${competenceNumber}`] = competence.verbes_affectifs || '';
                        data[`formulation_${competenceNumber}`] = competence.formulation;
                    });
                    return data;
                },
                loadingText: '⏳ Sauvegarde en cours...'
            });
            
            submitHandler();
        }

        function saveCompetencesSilently() {
            // Prepare data from selected competences
            const data = {};
            selectedCompetences.forEach((competence, index) => {
                const competenceNumber = index + 1;
                data[`titre_${competenceNumber}`] = competence.titre || `Compétence ${competenceNumber}`;
                data[`idees_cles_${competenceNumber}`] = competence.idees_cles;
                data[`niveau_${competenceNumber}`] = competence.niveau;
                data[`niveau_cognitif_${competenceNumber}`] = competence.niveau_cognitif || '';
                data[`niveau_affectif_${competenceNumber}`] = competence.niveau_affectif || '';
                data[`verbes_${competenceNumber}`] = competence.verbes;
                data[`verbes_cognitifs_${competenceNumber}`] = competence.verbes_cognitifs || '';
                data[`verbes_affectifs_${competenceNumber}`] = competence.verbes_affectifs || '';
                data[`formulation_${competenceNumber}`] = competence.formulation;
            });
            
            return fetch('/submit_competences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    return result;
                } else {
                    throw new Error(result.message || 'Erreur lors de la sauvegarde');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                throw error;
            });
        }

        function deleteSuggestion(index) { /* deprecated by unified pool */ }
        function deleteNewCompetence(id) { /* deprecated by unified pool */ }

        function deleteWorkshopItem(itemId) {
            const idx = workshopCompetences.findIndex(i => i.id === itemId);
            if (idx === -1) return;
            workshopCompetences.splice(idx, 1);
            displaySuggestionsPool();
            showSuccessMessage('Brouillon supprimé définitivement !');
        }

        function addWorkshopItemToSelected(itemId) {
            const idx = workshopCompetences.findIndex(i => i.id === itemId);
            if (idx === -1) return;
            if (!canAddMoreSelected()) {
                return;
            }
            const item = workshopCompetences[idx];
            selectedCompetences.push({ ...item, id: `competence_${selectedCompetences.length + 1}` });
            // Remove from workshop after adding
            workshopCompetences.splice(idx, 1);
            displaySelectedCompetences();
            displaySuggestionsPool();
            showSuccessMessage('Compétence ajoutée à votre formation !');
        }

        function editWorkshopItem(itemId) {
            const item = workshopCompetences.find(i => i.id === itemId);
            if (!item) return;
            const editModalContent = document.getElementById('editModalContent');
            editModalContent.innerHTML = `
                <div class="form-group">
                    <label>Titre de la compétence :</label>
                    <input type="text" id="editTitle" value="${item.titre || ''}" class="form-control">
                </div>
                <div class="form-group">
                    <label>Niveau cognitif :</label>
                    <select id="editNiveauCognitif" class="form-control" onchange="loadVerbsForDomain('cognitif')">
                        <option value="Haut">Haut</option>
                        <option value="Moyen">Moyen</option>
                        <option value="Bas">Bas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Verbes cognitifs :</label>
                    <div id="cognitiveVerbsContainer" class="bloom-verbs-container">
                        <p class="bloom-verbs-title">💡 Sélectionnez des verbes en cliquant sur les tags (cliquer à nouveau pour retirer).</p>
                        <div id="cognitiveVerbsList" class="bloom-verbs-list"></div>
                        <div id="selectedCognitiveTags" class="bloom-selected-tags"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Niveau affectif :</label>
                    <select id="editNiveauAffectif" class="form-control" onchange="loadVerbsForDomain('affectif')">
                        <option value="Haut">Haut</option>
                        <option value="Moyen">Moyen</option>
                        <option value="Bas">Bas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Verbes affectifs :</label>
                    <div id="affectiveVerbsContainer" class="bloom-verbs-container">
                        <p class="bloom-verbs-title">💡 Sélectionnez des verbes en cliquant sur les tags (cliquer à nouveau pour retirer).</p>
                        <div id="affectiveVerbsList" class="bloom-verbs-list"></div>
                        <div id="selectedAffectiveTags" class="bloom-selected-tags"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Idées clés :</label>
                    <textarea id="editIdeesCles" class="form-control">${item.idees_cles || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Formulation :</label>
                    <textarea id="editFormulation" class="form-control">${item.formulation || ''}</textarea>
                </div>
                <input type="hidden" id="editCompetenceId" value="ws:${item.id}">
            `;
            document.getElementById('editModal').style.display = 'block';
            (function(){
                const selCog = document.getElementById('editNiveauCognitif');
                const selAff = document.getElementById('editNiveauAffectif');
                const currentCog = item.niveau_cognitif && ['Bas','Moyen','Haut'].includes(item.niveau_cognitif) ? item.niveau_cognitif : 'Moyen';
                const currentAff = item.niveau_affectif && ['Bas','Moyen','Haut'].includes(item.niveau_affectif) ? item.niveau_affectif : 'Moyen';
                if (selCog) selCog.value = currentCog;
                if (selAff) selAff.value = currentAff;
            })();
            const hiddenCog = ensureHiddenVerbsInput('cognitif');
            const hiddenAff = ensureHiddenVerbsInput('affectif');
            hiddenCog.value = item.verbes_cognitifs || '';
            hiddenAff.value = item.verbes_affectifs || '';
            loadVerbsForDomain('cognitif');
            loadVerbsForDomain('affectif');
        }

        function deleteNewCompetence(competenceId) {
            // Find and remove the competence from new competences
            const competenceIndex = newCompetences.findIndex(c => c.id === competenceId);
            if (competenceIndex === -1) return;
            
            newCompetences.splice(competenceIndex, 1);
            
            // Update displays
            displaySuggestionsPool();
            
            showSuccessMessage('Brouillon supprimé définitivement !');
        }

        function removeAllCompetences() {
            const confirmed = confirm('Êtes-vous sûr de vouloir retirer toutes les compétences de votre formation ? Elles retourneront à l\'atelier d\'idées.');
            if (!confirmed) {
                return;
            }
            
            // Return all competences to the workshop
            selectedCompetences.forEach(competence => {
                if (competence.type === 'ai') {
                    // Return AI suggestion to pool
                    usedSuggestionIndices.delete(competence.suggestionIndex);
                } else {
                    // Add new competence to suggestions pool
                    newCompetences.push(competence);
                }
            });
            
            // Clear selected competences
            selectedCompetences = [];
            
            // Reset evaluation status
            evaluationCompleted = false;
            
            // Update displays
            displaySelectedCompetences();
            displaySuggestionsPool();
            
            showSuccessMessage('Toutes les compétences ont été retirées et retournées à l\'atelier d\'idées !');
        }

        function addNewCompetenceToSelected(competenceId) {
            // Find the competence in new competences
            const competenceIndex = newCompetences.findIndex(c => c.id === competenceId);
            if (competenceIndex === -1) return;
            if (!canAddMoreSelected()) {
                return;
            }
            
            const competence = newCompetences[competenceIndex];
            
            // Remove from new competences
            newCompetences.splice(competenceIndex, 1);
            
            // Add to selected competences
            selectedCompetences.push(competence);
            
            // Update displays
            displaySelectedCompetences();
            displaySuggestionsPool();
            
            showSuccessMessage('Compétence ajoutée à votre formation !');
        }


        function evaluateCompetences() {
            const evaluateBtn = document.getElementById('evaluateBtn');
            const evaluateLoading = document.getElementById('evaluateLoading');
            
            // Show loading state
            evaluateBtn.disabled = true;
            evaluateLoading.style.display = 'block';
            
            // First save current competences silently, then evaluate them
            saveCompetencesSilently()
                .then(() => {
                    // Then evaluate them
                    return fetch('/evaluate_and_order_competences', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // Display evaluation results in the new section
                        displayEvaluationResults(result.evaluation);
                        showSuccessMessage('Évaluation et ordonnancement terminés !');
                    } else {
                        alert('Erreur lors de l\'évaluation : ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erreur lors de l\'évaluation');
                })
                .finally(() => {
                    // Reset button state
                    evaluateBtn.disabled = false;
                    evaluateLoading.style.display = 'none';
                });
        }

        function displayEvaluationResults(evaluation) {
            const evaluationSection = document.getElementById('evaluationResultsSection');
            const evaluationContent = document.getElementById('evaluationResultsContent');
            
            // Show the evaluation results section
            evaluationSection.style.display = 'block';
            
            // Mark evaluation as completed
            evaluationCompleted = true;
            
            // Build the content
            let content = '';
            
            // Compétences ordonnées
            if (evaluation.ordre_competences && evaluation.ordre_competences.length > 0) {
                content += '<h3>📋 Compétences Ordonnées</h3>';
                content += '<div class="evaluation-results-content">';
                
                evaluation.ordre_competences.forEach(comp => {
                    const pertinenceColor = comp.pertinence === 'élevée' ? '#28a745' : 
                                           comp.pertinence === 'moyenne' ? '#ffc107' : '#dc3545';
                    
                    // Find the corresponding competence in selectedCompetences to get the title
                    let competenceTitle = '';
                    const competenceNumber = comp.code.replace('C', '');
                    const selectedCompetence = selectedCompetences[parseInt(competenceNumber) - 1];
                    if (selectedCompetence) {
                        competenceTitle = selectedCompetence.titre;
                    }
                    
                    content += `
                        <div class="competence-evaluation">
                            <h4>${comp.code} - ${competenceTitle}</h4>
                            <p class="competence-formulation">${comp.formulation}</p>
                            <p><strong>Justification :</strong> ${comp.justification}</p>
                            <p><strong>Pertinence :</strong> <span style="color: ${pertinenceColor};">${comp.pertinence}</span></p>
                        </div>
                    `;
                });
                
                content += '</div>';
            }
            
            // Compétences manquantes suggérées
            if (evaluation.competences_manquantes && evaluation.competences_manquantes.length > 0) {
                content += '<div class="competences-manquantes">';
                content += '<h3>🔧 Compétences Intermédiaires Suggérées</h3>';
                content += '<p>Ces compétences sont suggérées pour assurer une progression graduelle de la difficulté :</p>';
                
                evaluation.competences_manquantes.forEach((comp, index) => {
                    content += `
                        <div class="competence-suggestion">
                            <h4>${comp.titre}</h4>
                            <div class="suggestion-details">
                                <p><strong>Niveau :</strong> ${comp.niveau}</p>
                                <p><strong>Idées clés :</strong> ${comp.idees_cles}</p>
                                <p><strong>Verbes :</strong> ${comp.verbes}</p>
                                <p class="competence-formulation">${comp.formulation}</p>
                                <p><strong>Justification :</strong> ${comp.justification}</p>
                            </div>
                        </div>
                    `;
                });
                
                content += '</div>';
            }
            
            // Avis global
            if (evaluation.avis_global) {
                content += `
                    <div class="avis-global">
                        <h3>📊 Avis Global</h3>
                        <p>${evaluation.avis_global}</p>
                    </div>
                `;
            }
            
            // Points d'amélioration
            if (evaluation.points_amelioration && evaluation.points_amelioration.length > 0) {
                content += '<div class="points-amelioration">';
                content += '<h3>💡 Points d\'Amélioration</h3>';
                content += '<ul>';
                
                evaluation.points_amelioration.forEach(point => {
                    content += `<li>${point}</li>`;
                });
                
                content += '</ul>';
                content += '</div>';
            }
            
            // Update the content
            evaluationContent.innerHTML = content;
            
            // Update submit button visibility
            updateSubmitButtonVisibility();
        }
        
        function goToNextStep() {
            {% if nav_info and nav_info.next_route %}
                window.location.href = '{{ nav_info.next_route }}';
            {% endif %}
        }
    </script>
</body>
</html> 